define("dojo/dnd/Manager",["dojo","dojo/dnd/common","dojo/dnd/autoscroll","dojo/dnd/Avatar"],function(a){a.declare("dojo.dnd.Manager",null,{constructor:function(){this.avatar=null,this.source=null,this.nodes=[],this.copy=!0,this.target=null,this.canDropFlag=!1,this.events=[]},OFFSET_X:16,OFFSET_Y:16,overSource:function(b){this.avatar&&(this.target=b&&b.targetState!="Disabled"?b:null,this.canDropFlag=Boolean(this.target),this.avatar.update()),a.publish("/dnd/source/over",[b])},outSource:function(b){this.avatar?this.target==b&&(this.target=null,this.canDropFlag=!1,this.avatar.update(),a.publish("/dnd/source/over",[null])):a.publish("/dnd/source/over",[null])},startDrag:function(b,c,d){this.source=b,this.nodes=c,this.copy=Boolean(d),this.avatar=this.makeAvatar(),a.body().appendChild(this.avatar.node),a.publish("/dnd/start",[b,c,this.copy]),this.events=[a.connect(a.doc,"onmousemove",this,"onMouseMove"),a.connect(a.doc,"onmouseup",this,"onMouseUp"),a.connect(a.doc,"onkeydown",this,"onKeyDown"),a.connect(a.doc,"onkeyup",this,"onKeyUp"),a.connect(a.doc,"ondragstart",a.stopEvent),a.connect(a.body(),"onselectstart",a.stopEvent)];var e="dojoDnd"+(d?"Copy":"Move");a.addClass(a.body(),e)},canDrop:function(a){var b=Boolean(this.target&&a);this.canDropFlag!=b&&(this.canDropFlag=b,this.avatar.update())},stopDrag:function(){a.removeClass(a.body(),["dojoDndCopy","dojoDndMove"]),a.forEach(this.events,a.disconnect),this.events=[],this.avatar.destroy(),this.avatar=null,this.source=this.target=null,this.nodes=[]},makeAvatar:function(){return new a.dnd.Avatar(this)},updateAvatar:function(){this.avatar.update()},onMouseMove:function(b){var c=this.avatar;if(c){a.dnd.autoScrollNodes(b);var d=c.node.style;d.left=b.pageX+this.OFFSET_X+"px",d.top=b.pageY+this.OFFSET_Y+"px";var e=Boolean(this.source.copyState(a.isCopyKey(b)));this.copy!=e&&this._setCopyStatus(e)}},onMouseUp:function(b){if(this.avatar){if(this.target&&this.canDropFlag){var c=Boolean(this.source.copyState(a.isCopyKey(b))),d=[this.source,this.nodes,c,this.target,b];a.publish("/dnd/drop/before",d),a.publish("/dnd/drop",d)}else a.publish("/dnd/cancel");this.stopDrag()}},onKeyDown:function(b){if(this.avatar)switch(b.keyCode){case a.keys.CTRL:var c=Boolean(this.source.copyState(!0));this.copy!=c&&this._setCopyStatus(c);break;case a.keys.ESCAPE:a.publish("/dnd/cancel"),this.stopDrag()}},onKeyUp:function(b){if(this.avatar&&b.keyCode==a.keys.CTRL){var c=Boolean(this.source.copyState(!1));this.copy!=c&&this._setCopyStatus(c)}},_setCopyStatus:function(b){this.copy=b,this.source._markDndStatus(this.copy),this.updateAvatar(),a.replaceClass(a.body(),"dojoDnd"+(this.copy?"Copy":"Move"),"dojoDnd"+(this.copy?"Move":"Copy"))}}),a.dnd._manager=null,a.dnd.manager=function(){a.dnd._manager||(a.dnd._manager=new a.dnd.Manager);return a.dnd._manager};return a.dnd.Manager})