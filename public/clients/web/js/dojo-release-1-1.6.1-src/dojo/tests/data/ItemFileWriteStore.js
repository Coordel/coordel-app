define("tests/data/ItemFileWriteStore",["dojo","tests/data/readOnlyItemFileTestTemplates","dojo/data/ItemFileWriteStore","dojo/data/api/Read","dojo/data/api/Identity","dojo/data/api/Write","dojo/data/api/Notification"],function(a){a.getObject("data.ItemFileWriteStore",!0,tests),tests.data.readOnlyItemFileTestTemplates.registerTestsForDatastore("dojo.data.ItemFileWriteStore"),tests.data.ItemFileWriteStore.getTestData=function(b){var c={};b==="reference_integrity"&&(a.isBrowser?c={url:a.moduleUrl("tests","data/reference_integrity.json").toString()}:c={data:{identifier:"id",label:"name",items:[{id:1,name:"Item 1"},{id:2,name:"Item 2"},{id:3,name:"Item 3"},{id:4,name:"Item 4"},{id:5,name:"Item 5"},{id:6,name:"Item 6"},{id:7,name:"Item 7"},{id:8,name:"Item 8"},{id:9,name:"Item 9"},{id:10,name:"Item 10",friends:[{_reference:1},{_reference:3},{_reference:5}]},{id:11,name:"Item 11",friends:[{_reference:10}],siblings:[{_reference:10}]},{id:12,name:"Item 12",friends:[{_reference:3},{_reference:7}],enemies:[{_reference:10}]},{id:13,name:"Item 13",friends:[{_reference:10}]},{id:14,name:"Item 14",friends:[{_reference:11}]},{id:15,name:"item 15",friends:[{id:16,name:"Item 16"}]}]}});return c},doh.register("tests.data.ItemFileWriteStore",[function b(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=b.getFeatures();doh.assertTrue(c["dojo.data.api.Read"]!==null),doh.assertTrue(c["dojo.data.api.Identity"]!==null),doh.assertTrue(c["dojo.data.api.Write"]!==null),doh.assertTrue(c["dojo.data.api.Notification"]!==null),doh.assertFalse(c.iggy);var d=0;for(var e in c)doh.assertTrue(e==="dojo.data.api.Read"||e==="dojo.data.api.Identity"||e==="dojo.data.api.Write"||e==="dojo.data.api.Notification"),d++;doh.assertEqual(d,4)},function c(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred,d=function(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"capital","Cairo")),doh.assertEqual(b.isDirty(e),!1),doh.assertTrue(b.isDirty(e)===!1),doh.assertFalse(b.isDirty()),doh.assertTrue(b.isDirty(e)===!1),doh.assertTrue(!b.isDirty()),b.setValue(e,"capital","New Cairo"),doh.assertTrue(b.isDirty(e)),doh.assertTrue(b.isDirty()),doh.assertEqual(b.getValue(e,"capital").toString(),"New Cairo"),c.callback(!0)},e=function(a,b){c.errback(a)};b.fetch({query:{name:"Egypt"},onComplete:d,onError:e});return c},function d(){function e(a,b){c.errback(a)}function d(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Egypt")),doh.assertTrue(b.isDirty(e)===!1),doh.assertTrue(!b.isDirty()),b.setValues(e,"name",["Egypt 1","Egypt 2"]),doh.assertTrue(b.isDirty(e)),doh.assertTrue(b.isDirty());var f=b.getValues(e,"name");doh.assertTrue(f[0]=="Egypt 1"),doh.assertTrue(f[1]=="Egypt 2"),c.callback(!0)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetch({query:{name:"Egypt"},onComplete:d,onError:e});return c},function e(){function e(a,b){c.errback(a)}function d(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Egypt")),doh.assertTrue(b.isDirty(e)===!1),doh.assertTrue(!b.isDirty()),b.unsetAttribute(e,"name"),doh.assertTrue(b.isDirty(e)),doh.assertTrue(b.isDirty()),doh.assertTrue(!b.hasAttribute(e,"name")),c.callback(!0)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetch({query:{name:"Egypt"},onComplete:d,onError:e});return c},function f(){function g(a,b){c.errback(a)}function f(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Canada")),c.callback(!0)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;doh.assertTrue(!b.isDirty());var d=!1;b.onNew=function(a,c){doh.assertTrue(a!==null),doh.assertTrue(c===null),doh.assertTrue(b.isItem(a)),d=!0};var e=b.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});doh.assertTrue(d),doh.assertTrue(b.isDirty(e)),doh.assertTrue(b.isDirty()),doh.assertTrue(b.getValues(e,"name")=="Canada"),b.fetch({query:{name:"Canada"},onComplete:f,onError:g});return c},function g(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;doh.assertTrue(!b.isDirty());var d=function(a,b){c.errback(a)},e=function(a,e){function i(a,e){function f(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertEqual("Cairo",b.getValue(e,"name")),c.callback(!0)}doh.assertEqual(0,a.length),b.fetch({query:{name:"Cairo"},onComplete:f,onError:d,queryOptions:{deep:!0}})}doh.assertEqual(1,a.length);var f=a[0];doh.assertTrue(b.containsValue(f,"name","Egypt"));var g=!1;b.onNew=function(a,b){doh.assertEqual(f,b.item),doh.assertEqual("cities",b.attribute),doh.assertTrue(b.oldValue===undefined),doh.assertTrue(b.newValue===a),g=!0},b.onSet=function(a,b,c,d){doh.assertTrue(!1)};var h=b.newItem({name:"Cairo",abbr:"Cairo"},{parent:f,attribute:"cities"});doh.assertTrue(g),b.fetch({query:{name:"Cairo"},onComplete:i,onError:d})};b.fetch({query:{name:"Egypt"},onComplete:e,onError:d});return c},function h(){function e(a,b){c.errback(a)}function d(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Egypt")),b.onNew=function(a,b){doh.assertEqual(e,b.item),doh.assertEqual("cities",b.attribute),doh.assertTrue(b.oldValue===undefined),doh.assertTrue(b.newValue===a)};var f=b.newItem({name:"Cairo",abbr:"Cairo"},{parent:e,attribute:"cities"});b.onNew=function(a,b){doh.assertEqual(e,b.item),doh.assertEqual("cities",b.attribute),console.log(b.oldValue),doh.assertTrue(b.oldValue==f),doh.assertTrue(b.newValue[0]==f),doh.assertTrue(b.newValue[1]==a)};var g=b.newItem({name:"Banha",abbr:"Banha"},{parent:e,attribute:"cities"});b.onNew=function(a,b){doh.assertEqual(e,b.item),doh.assertEqual("cities",b.attribute),doh.assertTrue(b.oldValue[0]==f),doh.assertTrue(b.oldValue[1]==g),doh.assertTrue(b.newValue[0]==f),doh.assertTrue(b.newValue[1]==g),doh.assertTrue(b.newValue[2]==a)};var h=b.newItem({name:"Damanhur",abbr:"Damanhur"},{parent:e,attribute:"cities"});c.callback(!0)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;doh.assertTrue(!b.isDirty()),b.fetch({query:{name:"Egypt"},onComplete:d,onError:e});return c},function i(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred,d=function(a,b){c.errback(a)},e=function(a,e){doh.assertEqual(1,a.length);var f=a[0];doh.assertTrue(b.containsValue(f,"name","Egypt")),doh.assertTrue(b.isDirty(f)===!1),doh.assertTrue(!b.isDirty()),b.deleteItem(f),doh.assertTrue(b.isDirty(f)),doh.assertTrue(b.isDirty());var g=function(a,b){doh.assertEqual(0,a.length),c.callback(!0)};b.fetch({query:{name:"Egypt"},onComplete:g,onError:d})};b.fetch({query:{name:"Egypt"},onComplete:e,onError:d});return c},function j(){function e(a,b){c.errback(a)}function d(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Egypt")),b.setValue(e,"name","Egypt 2"),doh.assertTrue(b.getValue(e,"name")=="Egypt 2"),doh.assertTrue(b.isDirty(e)),c.callback(!0)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetch({query:{name:"Egypt"},onComplete:d,onError:e});return c},function k(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred,d=function(a,b){c.errback(a)},e=function(a,e){doh.assertEqual(1,a.length);var f=a[0];doh.assertTrue(b.containsValue(f,"name","Egypt")),doh.assertTrue(b.isDirty(f)===!1),doh.assertTrue(!b.isDirty()),b.setValue(f,"name","Egypt 2"),doh.assertTrue(b.getValue(f,"name")=="Egypt 2"),doh.assertTrue(b.isDirty(f)),doh.assertTrue(b.isDirty()),b.revert();var g=function(a,d){doh.assertEqual(1,a.length);var e=a[0];doh.assertTrue(b.containsValue(e,"name","Egypt")),c.callback(!0)};b.fetch({query:{name:"Egypt"},onComplete:g,onError:d})};b.fetch({query:{name:"Egypt"},onComplete:e,onError:d});return c},function l(){function e(a){function e(){c.callback(!0)}b.setValue(a,"capital","New Cairo"),b.save({onComplete:e,onError:d})}function d(a){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetchItemByIdentity({identity:"eg",onItem:e,onError:d});return c},function m(){function e(a){function e(){doh.assertTrue(!b._saveInProgress),c.callback(!0)}b.setValue(a,"capital","New Cairo"),b.save({onComplete:e,onError:d})}function d(a){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetchItemByIdentity({identity:"eg",onItem:e,onError:d});return c},function n(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c,d=new doh.Deferred,e=function(a){d.errback(a)};b._saveEverything=function(d,f,g){var h=a.fromJson(g);doh.assertEqual(h.identifier,b.getIdentityAttributes(c)[0]),doh.assertEqual(h.label,b.getLabelAttributes(c)[0]),doh.assertEqual(h.items.length,7);var i=new a.data.ItemFileWriteStore({data:h}),j=function(a){var d=a;doh.assertEqual(b.getIdentityAttributes(c)[0],i.getIdentityAttributes(d)[0]),doh.assertEqual(b.getLabelAttributes(c)[0],i.getLabelAttributes(d)[0]),doh.assertEqual(b.getValue(c,"name"),i.getValue(d,"name"))};i.fetchItemByIdentity({identity:"eg",onItem:j,onError:e}),d()};var f=function(a){c=a;var f=function(){d.callback(!0)};b.setValue(c,"capital","New Cairo"),b.save({onComplete:f,onError:e})};b.fetchItemByIdentity({identity:"eg",onItem:f,onError:e});return d},function o(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("geography_hierarchy_small"));b.hierarchical=!1;var c,d=new doh.Deferred,e=function(a){d.errback(a)};b._saveEverything=function(d,f,g){var h=a.fromJson(g);doh.assertEqual(h.items.length,3);var i=new a.data.ItemFileWriteStore({data:h,hierarchical:!1}),j=function(a,d){var e=a[0];doh.assertEqual(b.getValue(c,"name"),i.getValue(e,"name"))};i.fetch({query:{name:"Africa"},onComplete:j,onError:e,queryOptions:{deep:!0}}),d()};var f=function(a,f){c=a[0];var g=function(){d.callback(!0)};b.setValue(c,"size","HUGE!"),b.save({onComplete:g,onError:e})};b.fetch({query:{name:"Africa"},onComplete:f,onError:e,queryOptions:{deep:!0}});return d},function p(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b._saveEverything=function(b,d,e){function i(a,b){c.errback(a),d()}function h(c){var d=g.getValue(c,"independence");doh.assertTrue(d instanceof Date),doh.assertTrue(a.date.compare(new Date(1993,4,24),d,"date")===0),b()}var f=a.fromJson(e),g=new a.data.ItemFileWriteStore({data:f});g.fetchItemByIdentity({identity:"eg",onItem:h,onError:i})};var d=function(a){c.errback(a)},e=function(a){var e=function(){c.callback(!0)};b.setValue(a,"independence",new Date(1993,4,24)),b.save({onComplete:e,onError:d})};b.fetchItemByIdentity({identity:"eg",onItem:e,onError:d});return c},function q(){var b={identifier:"name",items:[{name:"Kermit",species:"frog",color:{_type:"Color",_value:"green"}},{name:"Beaker",hairColor:{_type:"Color",_value:"red"}}]},c={Color:a.Color},d=new a.data.ItemFileWriteStore({data:b,typeMap:c}),e=new doh.Deferred;d._saveEverything=function(b,d,e){function j(a,b){h.errback(a),d()}function i(c){var d=g.getValue(c,"hairColor");doh.assertTrue(d instanceof a.Color),doh.assertEqual("rgba(255, 255, 0, 1)",d.toString()),b()}var f=a.fromJson(e),g=new a.data.ItemFileWriteStore({data:f,typeMap:c}),h=new doh.Deferred;g.fetchItemByIdentity({identity:"Animal",onItem:i,onError:j})};var f=function(a){e.errback(a)},g=function(){e.callback(!0)},h=d.newItem({name:"Animal",hairColor:new a.Color("yellow")});d.save({onComplete:g,onError:f});return e},function r(){var b={identifier:"name",items:[{name:"Kermit",species:"frog",color:{_type:"Color",_value:"green"}},{name:"Beaker",hairColor:{_type:"Color",_value:"red"}}]},c={Color:{type:a.Color,deserialize:function(b){return new a.Color(b)},serialize:function(a){return a.toString()}}},d=new a.data.ItemFileWriteStore({data:b,typeMap:c}),e=new doh.Deferred;d._saveEverything=function(b,d,f){var g=a.fromJson(f),h=new a.data.ItemFileWriteStore({data:g,typeMap:c}),i=function(c){var d=h.getValue(c,"hairColor");doh.assertTrue(d instanceof a.Color),doh.assertEqual("rgba(255, 255, 0, 1)",d.toString()),b()},j=function(a,b){e.errback(a),d()};h.fetchItemByIdentity({identity:"Animal",onItem:i,onError:j})};var f=function(a){e.errback(a)},g=function(){e.callback(!0)},h=d.newItem({name:"Animal",hairColor:new a.Color("yellow")});d.save({onComplete:g,onError:f});return e},function s(){var b={data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}},c=new a.data.ItemFileWriteStore(b),d=c.newItem({name:"Utopia",capitol:"Perfect"}),e=d[c._itemNumPropName];doh.assertTrue(c._arrayOfAllItems[e]===d),c.revert(),doh.assertTrue(c._arrayOfAllItems[e]===null)},function t(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;doh.assertTrue(!b.isDirty());var d=function(a,b){c.errback(a)},e=function(a,e){var f=a.length,g=b.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});b.setValue(g,"someattribute","modified a new item!");var h=function(a,e){var g=a.length;doh.assertEqual(g,f+1),b.revert();var h=function(a,b){var d=a.length;doh.assertEqual(d,f),c.callback(!0)};b.fetch({onComplete:h,onError:d})};b.fetch({onComplete:h,onError:d})};b.fetch({onComplete:e,onError:d});return c},function u(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c,d=!1,e=new doh.Deferred;doh.assertTrue(!b.isDirty());var f=function(a,b){e.errback(a)},g=function(a,g){var h=a.length,i=b.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"});b.setValue(i,"someattribute","modified a new item!");var j=function(a,g){var j=a.length;doh.assertEqual(j,h+1),b.deleteItem(i);var k=function(a,g){var i=a.length;doh.assertEqual(h,i);for(c=0;c<a.length;c++){d=b.getIdentity(a[c])==="ca";if(d)break}if(d)e.errback(new Error("Error: Found the supposedly deleted item!"));else{b.revert();var j=function(a,f){var g=a.length;doh.assertEqual(g,h);for(c=0;c<a.length;c++){d=b.getIdentity(a[c])==="ca";if(d)break}d?e.errback(new Error("Error: Found the 'new' item after revert!")):e.callback(!0)};b.fetch({onComplete:j,onError:f})}};b.fetch({onComplete:k,onError:f})};b.fetch({onComplete:j,onError:f})};b.fetch({onComplete:g,onError:f});return e},function v(){function e(d){function g(d,g,h,i){doh.assertTrue(b.isItem(d)),doh.assertTrue(d==e),doh.assertTrue(g=="capital"),doh.assertTrue(h=="Cairo"),doh.assertTrue(i=="New Cairo"),c.callback(!0),a.disconnect(f)}var e=d,f=null;f=a.connect(b,"onSet",g),b.setValue(e,"capital","New Cairo")}function d(a){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetchItemByIdentity({identity:"eg",onItem:e,onError:d})},function w(){function e(e){doh.assertTrue(b.isItem(e)),doh.assertTrue(b.getValue(e,"name")=="Canada"),c.callback(!0),a.disconnect(d)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred,d=null;d=a.connect(b,"onNew",e);var f=b.newItem({name:"Canada",abbr:"ca",capital:"Ottawa"})},function x(){function e(d){function g(d){doh.assertTrue(b.isItem(d)===!1),doh.assertTrue(d==e),c.callback(!0),a.disconnect(f)}var e=d,f=null;f=a.connect(b,"onDelete",g),b.deleteItem(e)}function d(a){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new doh.Deferred;b.fetchItemByIdentity({identity:"eg",onItem:e,onError:d})},function y(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new a.data.api.Read,d=!0;for(var e in c){var f=c[e];if(typeof f==="function"){var g=b[e];if(typeof g!=="function"){d=!1;break}}}doh.assertTrue(d)},function z(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new a.data.api.Write,d=!0;for(var e in c){var f=c[e];if(typeof f==="function"){var g=b[e];if(typeof g!=="function"){d=!1;break}}}doh.assertTrue(d)},function A(){var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries")),c=new a.data.api.Notification,d=!0;for(var e in c){var f=c[e];if(typeof f==="function"){var g=b[e];if(typeof g!=="function"){d=!1;break}}}doh.assertTrue(d)},function B(){var b={data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}},c=new a.data.ItemFileWriteStore(b),d=new doh.Deferred,e=function(a,b){d.errback(a)},f=function(a,b){doh.assertEqual(7,a.length);var f=a[a.length-1],g=c.getIdentity(f);c.deleteItem(f),c.newItem({name:"Canada",capital:"Ottawa"});var h=function(a,b){doh.assertEqual(7,a.length);var e={};for(var f=0;f<a.length;++f){var g=a[f],h=c.getIdentity(g);e.hasOwnProperty(h)?doh.assertTrue(!1):e[h]=g}d.callback(!0)};c.fetch({onComplete:h,onError:e})};c.fetch({onComplete:f,onError:e});return d},function C(){var b={data:{label:"name",items:[{name:"Ecuador",capital:"Quito"},{name:"Egypt",capital:"Cairo"},{name:"El Salvador",capital:"San Salvador"},{name:"Equatorial Guinea",capital:"Malabo"},{name:"Eritrea",capital:"Asmara"},{name:"Estonia",capital:"Tallinn"},{name:"Ethiopia",capital:"Addis Ababa"}]}},c=new a.data.ItemFileWriteStore(b),d=new doh.Deferred,e=function(a,b){d.errback(a)},f=function(a,b){doh.assertEqual(7,a.length);var f=a[a.length-1],g=c.getIdentity(f);c.deleteItem(f),c.newItem({name:"Canada",capital:"Ottawa"});var h=function(a,b){doh.assertEqual(7,a.length);var f={};for(var g=0;g<a.length;++g){var h=a[g],i=c.getIdentity(h);f.hasOwnProperty(i)?doh.assertTrue(!1):f[i]=h}c.revert();var j=function(a,b){doh.assertEqual(7,a.length),d.callback(!0)};c.fetch({onComplete:j,onError:e})};c.fetch({onComplete:h,onError:e})};c.fetch({onComplete:f,onError:e});return d},function D(){var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=function(a,b){c.errback(a)},e=function(a,d){var e=null,f=null,g=null,h=null,i;for(i=0;i<a.length;i++){var j=b.getIdentity(a[i]);j===10?e=a[i]:j===1?f=a[i]:j===3?g=a[i]:j===5&&(h=a[i])}var k=b.getValues(e,"friends");doh.assertTrue(k!==null),doh.assertTrue(k!==undefined),doh.assertTrue(b.isItem(e)),doh.assertTrue(b.isItem(f)),doh.assertTrue(b.isItem(g)),doh.assertTrue(b.isItem(h));var l=0;try{for(i=0;i<k.length;i++)i===0?(doh.assertTrue(b.isItem(k[i])),doh.assertEqual(k[i],f),doh.assertEqual(b.getIdentity(k[i]),1),l++):i===1?(doh.assertTrue(b.isItem(k[i])),doh.assertEqual(k[i],g),doh.assertEqual(b.getIdentity(k[i]),3),l++):i===2&&(doh.assertTrue(b.isItem(k[i])),doh.assertEqual(k[i],h),doh.assertEqual(b.getIdentity(k[i]),5),l++)}catch(m){doh.errback(m)}doh.assertEqual(3,l),c.callback(!0)};b.fetch({onError:d,onComplete:e});return c},function E(){function f(d,f){try{console.log("Before delete map state is: "+a.toJson(d[b._reverseRefMap])),b.deleteItem(d),console.log("After delete map state is: "+a.toJson(d[b._reverseRefMap]));function g(a,d){var e=!0;for(var f=0;f<a.length;f++){var g=a[f],h=b.getAttributes(g);for(var i=0;i<h.length;i++){var j=b.getValues(g,h[i]),k=!1;for(var l=0;l<j.length;l++){var m=j[l];try{var n=b.getIdentity(m);if(n==10){k=!0;break}}catch(o){}}if(k){c.errback(new Error("Found a reference remaining to a deleted item.  Failure.")),e=!1;break}}}e&&c.callback(!0)}b.fetch({onComplete:g,onError:e})}catch(h){c.errback(h)}}function e(a,b){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:10,onError:e,onItem:f});return c},function F(){function f(e,f){try{console.log("Map before delete:"),b._dumpReferenceMap();var g=a.toJson(e[b._reverseRefMap]);b.deleteItem(e),console.log("Map after delete:"),b._dumpReferenceMap();var h=a.toJson(e[b._reverseRefMap]);b.revert(),console.log("Map after revert:"),b._dumpReferenceMap();var i=a.toJson(e[b._reverseRefMap]);doh.assertTrue(i===g)}catch(j){c.errback(j),d=!1}d&&c.callback(!0)}function e(a,b){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:10,onError:e,onItem:f});return c},function G(){function f(a,d){function g(a,d){doh.assertTrue(b.isItem(a));var g=a;b.deleteItem(f),b.deleteItem(g);try{b.revert();function h(a,b){c.callback(!0)}b.fetch({query:{name:"*"},start:0,count:20,onComplete:h,onError:e})}catch(i){c.errback(i)}}doh.assertTrue(b.isItem(a));var f=a;b.fetchItemByIdentity({identity:"Nairobi",onError:e,onItem:g})}function e(a,b){c.errback(a),doh.assertTrue(!1)}var b=new a.data.ItemFileWriteStore(tests.data.readOnlyItemFileTestTemplates.getTestData("countries_references")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:"Egypt",onError:e,onItem:f});return c},function H(){function f(d,f){try{b.setValues(d,"friends",[null]);function g(e,f){var g=e[b._reverseRefMap];b._dumpReferenceMap(),console.log("MAP for Item 10 is: "+a.toJson(g)),doh.assertTrue(!g["11"].friends),b.setValues(d,"siblings",[0,1,2]),doh.assertTrue(!g["11"]),c.callback(!0)}b.fetchItemByIdentity({identity:10,onError:e,onItem:g})}catch(h){console.debug(h),c.errback(h),doh.assertTrue(!1)}}function e(a,b){c.errback(a),doh.assertTrue(!1)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:11,onError:e,onItem:f});return c},function I(){function f(d,f){try{console.log("Reference state for item 16 is: "+a.toJson(d[b._reverseRefMap])),b.deleteItem(d);function g(a,d){var e=!0;for(var f=0;f<a.length;f++){var g=a[f],h=b.getAttributes(g);for(var i=0;i<h.length;i++){var j=b.getValues(g,h[i]),k=!1;for(var l=0;l<j.length;l++){var m=j[l];try{var n=b.getIdentity(m);if(n==16){k=!0;break}}catch(o){}}if(k){c.errback(new Error("Found a reference remaining to a deleted item.  Failure.")),e=!1;break}}}e&&c.callback(!0)}b.fetch({onComplete:g,onError:e})}catch(h){c.errback(h)}}function e(a,b){c.errback(a)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:16,onError:e,onItem:f});return c},function J(){function f(d,e){doh.assertTrue(d.length>2);var f=d[0],g=d[1];console.log("Map state for Item 1 is: "+a.toJson(f[b._reverseRefMap])),console.log("Map state for Item 2 is: "+a.toJson(g[b._reverseRefMap])),b.setValue(f,"siblings",g),console.log("Map state for Item 1 is: "+a.toJson(f[b._reverseRefMap])),console.log("Map state for Item 2 is: "+a.toJson(g[b._reverseRefMap])),doh.assertTrue(g[b._reverseRefMap]!==null),doh.assertTrue(g[b._reverseRefMap][b.getIdentity(f)].siblings),c.callback(!0)}function e(a,b){c.errback(a),doh.assertTrue(!1)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetch({onError:e,onComplete:f});return c},function K(){function f(e,f){try{var g=b.newItem({id:17,name:"Item 17"},{parent:e,attribute:"uncles"}),h=g[b._reverseRefMap];doh.assertTrue(h["10"].uncles),console.log("State of map of item 17 after newItem: "+a.toJson(h))}catch(i){console.debug(i),c.errback(i),doh.assertTrue(!1),d=!1}d&&c.callback(!0)}function e(a,b){c.errback(a),doh.assertTrue(!1)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:10,onError:e,onItem:f});return c},function L(){function f(e,f){try{console.log("State of reference map to item 10 before newItem: "+a.toJson(e[b._reverseRefMap]));var g=b.newItem({id:17,name:"Item 17",friends:[e]}),h=e[b._reverseRefMap];doh.assertTrue(h["17"].friends),console.log("State of reference map to item 10 after newItem: "+a.toJson(h))}catch(i){console.debug(i),c.errback(i),doh.assertTrue(!1),d=!1}d&&c.callback(!0)}function e(a,b){c.errback(a),doh.assertTrue(!1)}var b=new a.data.ItemFileWriteStore(tests.data.ItemFileWriteStore.getTestData("reference_integrity")),c=new doh.Deferred,d=!0;b.fetchItemByIdentity({identity:10,onError:e,onItem:f});return c},function M(){function f(a,b){a[c._reverseRefMap]===undefined?d.callback(!0):d.errback(new Error("Disabling of reference integrity failed."))}function e(a,b){d.errback(a),doh.assertTrue(!1)}var b=tests.data.ItemFileWriteStore.getTestData("reference_integrity");b.referenceIntegrity=!1;var c=new a.data.ItemFileWriteStore(b),d=new doh.Deferred;c.fetchItemByIdentity({identity:10,onError:e,onItem:f});return d},function N(){if(a.isBrowser){var b=tests.data.readOnlyItemFileTestTemplates.getTestData("countries");b.clearOnClose=!0,b.urlPreventCache=!0;var c=new a.data.ItemFileWriteStore(b),d=new doh.Deferred,e=function(a){var b=null;try{doh.assertTrue(a!==null);var e=a,f=c.getValue(e,"name");doh.assertEqual("Ecuador",f);var g=c.newItem({abbr:"foo",name:"bar"});c.close()}catch(h){b=h}b===null?d.errback(new Error("Store was dirty, should have thrown an error on close!")):d.callback(!0)},f=function(a){d.errback(a)};c.fetchItemByIdentity({identity:"ec",onItem:e,onError:f});return d}}])})