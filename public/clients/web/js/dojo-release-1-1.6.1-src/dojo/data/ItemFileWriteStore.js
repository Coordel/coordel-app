define("dojo/data/ItemFileWriteStore",["dojo","dojo/data/ItemFileReadStore"],function(a){a.declare("dojo.data.ItemFileWriteStore",a.data.ItemFileReadStore,{constructor:function(b){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(b){return a.date.stamp.toISOString(b,{zulu:!0})}),b&&b.referenceIntegrity===!1&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(a){if(!a)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){var a=this.getFeatures()["dojo.data.api.Identity"];return a},newItem:function(b,c){this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad();if(typeof b!="object"&&typeof b!="undefined")throw new Error("newItem() was passed something other than an object");var d=null,e=this._getIdentifierAttribute();if(e===Number)d=this._arrayOfAllItems.length;else{d=b[e];if(typeof d==="undefined")throw new Error("newItem() was not passed an identity for the new item");if(a.isArray(d))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert(typeof this._itemsByIdentity[d]==="undefined"),this._assert(typeof this._pending._newItems[d]==="undefined"),this._assert(typeof this._pending._deletedItems[d]==="undefined");var f={};f[this._storeRefPropName]=this,f[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[d]=f,f[e]=[d]),this._arrayOfAllItems.push(f);var g=null;if(c&&c.parent&&c.attribute){g={item:c.parent,attribute:c.attribute,oldValue:undefined};var h=this.getValues(c.parent,c.attribute);if(h&&h.length>0){var i=h.slice(0,h.length);h.length===1?g.oldValue=h[0]:g.oldValue=h.slice(0,h.length),i.push(f),this._setValueOrValues(c.parent,c.attribute,i,!1),g.newValue=this.getValues(c.parent,c.attribute)}else this._setValueOrValues(c.parent,c.attribute,f,!1),g.newValue=f}else f[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(f);this._pending._newItems[d]=f;for(var j in b){if(j===this._storeRefPropName||j===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var k=b[j];a.isArray(k)||(k=[k]),f[j]=k;if(this.referenceIntegrity)for(var l=0;l<k.length;l++){var m=k[l];this.isItem(m)&&this._addReferenceToMap(m,f,j)}}this.onNew(f,g);return f},_removeArrayElement:function(b,c){var d=a.indexOf(b,c);if(d!=-1){b.splice(d,1);return!0}return!1},deleteItem:function(b){this._assert(!this._saveInProgress),this._assertIsItem(b);var c=b[this._itemNumPropName],d=this.getIdentity(b);if(this.referenceIntegrity){var e=this.getAttributes(b);b[this._reverseRefMap]&&(b["backup_"+this._reverseRefMap]=a.clone(b[this._reverseRefMap])),a.forEach(e,function(c){a.forEach(this.getValues(b,c),function(a){this.isItem(a)&&(b["backupRefs_"+this._reverseRefMap]||(b["backupRefs_"+this._reverseRefMap]=[]),b["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(a),attr:c}),this._removeReferenceFromMap(a,b,c))},this)},this);var f=b[this._reverseRefMap];if(f)for(var g in f){var h=null;this._itemsByIdentity?h=this._itemsByIdentity[g]:h=this._arrayOfAllItems[g];if(h)for(var i in f[g]){var j=this.getValues(h,i)||[],k=a.filter(j,function(a){return!this.isItem(a)||this.getIdentity(a)!=d},this);this._removeReferenceFromMap(b,h,i),k.length<j.length&&this._setValueOrValues(h,i,k,!0)}}}this._arrayOfAllItems[c]=null,b[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[d],this._pending._deletedItems[d]=b,b[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,b),this.onDelete(b);return!0},setValue:function(a,b,c){return this._setValueOrValues(a,b,c,!0)},setValues:function(a,b,c){return this._setValueOrValues(a,b,c,!0)},unsetAttribute:function(a,b){return this._setValueOrValues(a,b,[],!0)},_setValueOrValues:function(b,c,d,e){this._assert(!this._saveInProgress),this._assertIsItem(b),this._assert(a.isString(c)),this._assert(typeof d!=="undefined");var f=this._getIdentifierAttribute();if(c==f)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var g=this._getValueOrValues(b,c),h=this.getIdentity(b);if(!this._pending._modifiedItems[h]){var i={};for(var j in b)j===this._storeRefPropName||j===this._itemNumPropName||j===this._rootItemPropName?i[j]=b[j]:j===this._reverseRefMap?i[j]=a.clone(b[j]):i[j]=b[j].slice(0,b[j].length);this._pending._modifiedItems[h]=i}var k=!1;if(a.isArray(d)&&d.length===0){k=delete b[c],d=undefined;if(this.referenceIntegrity&&g){var l=g;a.isArray(l)||(l=[l]);for(var m=0;m<l.length;m++){var n=l[m];this.isItem(n)&&this._removeReferenceFromMap(n,b,c)}}}else{var o;if(a.isArray(d)){var p=d;o=d.slice(0,d.length)}else o=[d];if(this.referenceIntegrity)if(g){var l=g;a.isArray(l)||(l=[l]);var q={};a.forEach(l,function(a){if(this.isItem(a)){var b=this.getIdentity(a);q[b.toString()]=!0}},this),a.forEach(o,function(a){if(this.isItem(a)){var d=this.getIdentity(a);q[d.toString()]?delete q[d.toString()]:this._addReferenceToMap(a,b,c)}},this);for(var r in q){var s;this._itemsByIdentity?s=this._itemsByIdentity[r]:s=this._arrayOfAllItems[r],this._removeReferenceFromMap(s,b,c)}}else for(var m=0;m<o.length;m++){var n=o[m];this.isItem(n)&&this._addReferenceToMap(n,b,c)}b[c]=o,k=!0}e&&this.onSet(b,c,g,d);return k},_addReferenceToMap:function(a,b,c){var d=this.getIdentity(b),e=a[this._reverseRefMap];e||(e=a[this._reverseRefMap]={});var f=e[d];f||(f=e[d]={}),f[c]=!0},_removeReferenceFromMap:function(a,b,c){var d=this.getIdentity(b),e=a[this._reverseRefMap],f;if(e){for(f in e)f==d&&(delete e[f][c],this._isEmpty(e[f])&&delete e[f]);this._isEmpty(e)&&delete a[this._reverseRefMap]}},_dumpReferenceMap:function(){var b;for(b=0;b<this._arrayOfAllItems.length;b++){var c=this._arrayOfAllItems[b];c&&c[this._reverseRefMap]&&console.log("Item: ["+this.getIdentity(c)+"] is referenced by: "+a.toJson(c[this._reverseRefMap]))}},_getValueOrValues:function(a,b){var c=undefined;if(this.hasAttribute(a,b)){var d=this.getValues(a,b);d.length==1?c=d[0]:c=d}return c},_flatten:function(b){if(this.isItem(b)){var c=b,d=this.getIdentity(c),e={_reference:d};return e}if(typeof b==="object")for(var f in this._datatypeMap){var g=this._datatypeMap[f];if(a.isObject(g)&&!a.isFunction(g)){if(b instanceof g.type){if(!g.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+f+"]");return{_type:f,_value:g.serialize(b)}}}else if(b instanceof g)return{_type:f,_value:b.toString()}}return b},_getNewFileContentString:function(){var b={},c=this._getIdentifierAttribute();c!==Number&&(b.identifier=c),this._labelAttr&&(b.label=this._labelAttr),b.items=[];for(var d=0;d<this._arrayOfAllItems.length;++d){var e=this._arrayOfAllItems[d];if(e!==null){var f={};for(var g in e)if(g!==this._storeRefPropName&&g!==this._itemNumPropName&&g!==this._reverseRefMap&&g!==this._rootItemPropName){var h=g,i=this.getValues(e,h);if(i.length==1)f[h]=this._flatten(i[0]);else{var j=[];for(var k=0;k<i.length;++k)j.push(this._flatten(i[k])),f[h]=j}}b.items.push(f)}}var l=!0;return a.toJson(b,l)},_isEmpty:function(b){var c=!0;if(a.isObject(b)){var d;for(d in b){c=!1;break}}else a.isArray(b)&&(b.length>0&&(c=!1));return c},save:function(b){this._assert(!this._saveInProgress),this._saveInProgress=!0;var c=this,d=function(){c._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},c._saveInProgress=!1;if(b&&b.onComplete){var d=b.scope||a.global;b.onComplete.call(d)}},e=function(d){c._saveInProgress=!1;if(b&&b.onError){var e=b.scope||a.global;b.onError.call(e,d)}};if(this._saveEverything){var f=this._getNewFileContentString();this._saveEverything(d,e,f)}this._saveCustom&&this._saveCustom(d,e),!this._saveEverything&&!this._saveCustom&&d()},revert:function(){this._assert(!this._saveInProgress);var b;for(b in this._pending._modifiedItems){var c=this._pending._modifiedItems[b],d=null;this._itemsByIdentity?d=this._itemsByIdentity[b]:d=this._arrayOfAllItems[b],c[this._storeRefPropName]=this;for(key in d)delete d[key];a.mixin(d,c)}var e;for(b in this._pending._deletedItems){e=this._pending._deletedItems[b],e[this._storeRefPropName]=this;var f=e[this._itemNumPropName];e["backup_"+this._reverseRefMap]&&(e[this._reverseRefMap]=e["backup_"+this._reverseRefMap],delete e["backup_"+this._reverseRefMap]),this._arrayOfAllItems[f]=e,this._itemsByIdentity&&(this._itemsByIdentity[b]=e),e[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(e)}for(b in this._pending._deletedItems)e=this._pending._deletedItems[b],e["backupRefs_"+this._reverseRefMap]&&(a.forEach(e["backupRefs_"+this._reverseRefMap],function(a){var b;this._itemsByIdentity?b=this._itemsByIdentity[a.id]:b=this._arrayOfAllItems[a.id],this._addReferenceToMap(b,e,a.attr)},this),delete e["backupRefs_"+this._reverseRefMap]);for(b in this._pending._newItems){var g=this._pending._newItems[b];g[this._storeRefPropName]=null,this._arrayOfAllItems[g[this._itemNumPropName]]=null,g[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,g),this._itemsByIdentity&&delete this._itemsByIdentity[b]}this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};return!0},isDirty:function(a){if(a){var b=this.getIdentity(a);return(new Boolean(this._pending._newItems[b]||this._pending._modifiedItems[b]||this._pending._deletedItems[b])).valueOf()}if(!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems))return!0;return!1},onSet:function(a,b,c,d){},onNew:function(a,b){},onDelete:function(a){},close:function(a){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}});return a.data.ItemFileWriteStore})