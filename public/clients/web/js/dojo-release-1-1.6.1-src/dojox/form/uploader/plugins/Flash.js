define(["dojo","dojox/embed/Flash","dojox/form/uploader/plugins/HTML5"],function(a){a.declare("dojox.form.uploader.plugins.Flash",[],{swfPath:a.config.uploaderPath||a.moduleUrl("dojox.form","resources/uploader.swf"),skipServerCheck:!0,serverTimeout:2e3,isDebug:!1,devMode:!1,deferredUploading:0,force:"",postMixInProperties:function(){this.supports("multiple")||(this.uploadType="flash",this._files=[],this._fileMap={},this._createInput=this._createFlashUploader,this.getFileList=this.getFlashFileList,this.reset=this.flashReset,this.upload=this.uploadFlash,this.submit=this.submitFlash,this.fieldname="flashUploadFiles"),this.inherited(arguments)},onReady:function(a){},onLoad:function(a){},onFileChange:function(a){},onFileProgress:function(a){},getFlashFileList:function(){return this._files},flashReset:function(){this.flashMovie.reset(),this._files=[]},uploadFlash:function(a){this.onBegin(this.getFileList()),this.flashMovie.doUpload(a)},submitFlash:function(b){var c=b?a.formToObject(b):null;this.onBegin(this.getFileList()),this.flashMovie.doUpload(c)},_change:function(b){this._files=this._files.concat(b),a.forEach(b,function(a){a.bytesLoaded=0,a.bytesTotal=a.size,this._fileMap[a.name+"_"+a.size]=a},this),this.onChange(this._files),this.onFileChange(b)},_complete:function(a){var b=this._getCustomEvent();b.type="load",this.onComplete(a)},_progress:function(a){this._fileMap[a.name+"_"+a.bytesTotal].bytesLoaded=a.bytesLoaded;var b=this._getCustomEvent();this.onFileProgress(a),this.onProgress(b)},_error:function(a){this.onError(a)},_onFlashBlur:function(a){},_getCustomEvent:function(){var a={bytesLoaded:0,bytesTotal:0,type:"progress",timeStamp:(new Date).getTime()};for(var b in this._fileMap)a.bytesTotal+=this._fileMap[b].bytesTotal,a.bytesLoaded+=this._fileMap[b].bytesLoaded;a.decimal=a.bytesLoaded/a.bytesTotal,a.percent=Math.ceil(a.bytesLoaded/a.bytesTotal*100)+"%";return a},_connectFlash:function(){this._subs=[],this._cons=[];var b=a.hitch(this,function(b,c){this._subs.push(a.subscribe(this.id+b,this,c))});b("/filesSelected","_change"),b("/filesUploaded","_complete"),b("/filesProgress","_progress"),b("/filesError","_error"),b("/filesCanceled","onCancel"),b("/stageBlur","_onFlashBlur");var c=a.hitch(this,function(b,c){this._cons.push(a.subscribe(this.id+b,this,function(a){this.button._cssMouseEvent({type:c})}))});c("/up","mouseup"),c("/down","mousedown"),c("/over","mouseover"),c("/out","mouseout"),this.connect(this.domNode,"focus",function(){this.flashMovie.focus(),this.flashMovie.doFocus()}),this.tabIndex>=0&&a.attr(this.domNode,"tabIndex",this.tabIndex)},_createFlashUploader:function(){var b=this.getUrl();if(b){if(b.toLowerCase().indexOf("http")<0&&b.indexOf("/")!=0){var c=window.location.href.split("/");c.pop(),c=c.join("/")+"/",b=c+b}}else console.warn("Warning: no uploadUrl provided.");this.inputNode=a.create("div",{className:"dojoxFlashNode"},this.domNode,"first"),a.style(this.inputNode,{position:"absolute",top:"-2px",width:this.btnSize.w+"px",height:this.btnSize.h+"px",opacity:0});var d=this.btnSize.w,e=this.btnSize.h,f={expressInstall:!0,path:(this.swfPath.uri||this.swfPath)+"?cb_"+(new Date).getTime(),width:d,height:e,allowScriptAccess:"always",allowNetworking:"all",vars:{uploadDataFieldName:this.flashFieldName||this.name+"Flash",uploadUrl:b,uploadOnSelect:this.uploadOnSelect,deferredUploading:this.deferredUploading||0,selectMultipleFiles:this.multiple,id:this.id,isDebug:this.isDebug,noReturnCheck:this.skipServerCheck,serverTimeout:this.serverTimeout},params:{scale:"noscale",wmode:"transparent",wmode:"opaque",allowScriptAccess:"always",allowNetworking:"all"}};this.flashObject=new dojox.embed.Flash(f,this.inputNode),this.flashObject.onError=a.hitch(function(a){console.error("Flash Error: "+a)}),this.flashObject.onReady=a.hitch(this,function(){this.onReady(this)}),this.flashObject.onLoad=a.hitch(this,function(a){this.flashMovie=a,this.flashReady=!0,this.onLoad(this)}),this._connectFlash()}}),dojox.form.addUploaderPlugin(dojox.form.uploader.plugins.Flash);return dojox.form.uploader.plugins.Flash})