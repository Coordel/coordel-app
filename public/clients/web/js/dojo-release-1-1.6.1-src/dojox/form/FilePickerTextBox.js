dojo.provide("dojox.form.FilePickerTextBox"),dojo.require("dojo.window"),dojo.require("dijit.form.ValidationTextBox"),dojo.require("dijit._HasDropDown"),dojo.require("dojox.widget.FilePicker"),dojo.declare("dojox.form.FilePickerTextBox",[dijit.form.ValidationTextBox,dijit._HasDropDown],{baseClass:"dojoxFilePickerTextBox",templateString:dojo.cache("dojox.form","resources/FilePickerTextBox.html"),searchDelay:500,valueItem:null,numPanes:2.25,postMixInProperties:function(){this.inherited(arguments),this.dropDown=new dojox.widget.FilePicker(this.constraints)},postCreate:function(){this.inherited(arguments),this.connect(this.dropDown,"onChange",this._onWidgetChange),this.connect(this.focusNode,"onblur","_focusBlur"),this.connect(this.focusNode,"onfocus","_focusFocus"),this.connect(this.focusNode,"ondblclick",function(){dijit.selectInputText(this.focusNode)})},_setValueAttr:function(a,b,c){if(!this._searchInProgress){this.inherited(arguments),a=a||"";var d=this.dropDown.get("pathValue")||"";if(a!==d){this._skip=!0;var e=dojo.hitch(this,"_setBlurValue");this.dropDown._setPathValueAttr(a,!c,this._settingBlurValue?e:null)}}},_onWidgetChange:function(a){if(!a&&this.focusNode.value)this._hasValidPath=!1,this.focusNode.value="";else{this.valueItem=a;var b=this.dropDown._getPathValueAttr(a);b&&(this._hasValidPath=!0),this._skip||this._setValueAttr(b,undefined,!0),delete this._skip}this.validate()},startup:function(){this.dropDown._started||this.dropDown.startup(),this.inherited(arguments)},openDropDown:function(){this.dropDown.domNode.style.width="0px","minPaneWidth"in(this.constraints||{})||this.dropDown.set("minPaneWidth",this.domNode.offsetWidth/this.numPanes),this.inherited(arguments)},toggleDropDown:function(){this.inherited(arguments),this._opened&&this.dropDown.set("pathValue",this.get("value"))},_focusBlur:function(a){a.explicitOriginalTarget!=this.focusNode||this._allowBlur?this._menuFocus&&(this.dropDown._updateClass(this._menuFocus,"Item",{Hover:!1}),delete this._menuFocus):window.setTimeout(dojo.hitch(this,function(){this._allowBlur||this.focus()}),1)},_focusFocus:function(a){this._menuFocus&&this.dropDown._updateClass(this._menuFocus,"Item",{Hover:!1}),delete this._menuFocus;var b=dijit.getFocus(this);b&&b.node&&(b=dijit.byNode(b.node),b&&(this._menuFocus=b.domNode)),this._menuFocus&&this.dropDown._updateClass(this._menuFocus,"Item",{Hover:!0}),delete this._allowBlur},_onBlur:function(){this._allowBlur=!0,delete this.dropDown._savedFocus,this.inherited(arguments)},_setBlurValue:function(){this.dropDown&&!this._settingBlurValue?(this._settingBlurValue=!0,this.set("value",this.focusNode.value)):(delete this._settingBlurValue,this.inherited(arguments))},parse:function(a,b){if(this._hasValidPath||this._hasSelection)return a;var c=this.dropDown,d=c.topDir,e=c.pathSeparator,f=c.get("pathValue"),g=function(a){d.length&&a.indexOf(d)===0&&(a=a.substring(d.length)),e&&a[a.length-1]==e&&(a=a.substring(0,a.length-1));return a};f=g(f);var h=g(a);if(h==f)return a;return undefined},_startSearchFromInput:function(){var a=this.dropDown,b=this.focusNode,c=b.value,d=c,e=a.topDir;this._hasSelection&&dijit.selectInputText(b,d.length),this._hasSelection=!1,e.length&&c.indexOf(e)===0&&(c=c.substring(e.length));var f=c.split(a.pathSeparator),g=dojo.hitch(this,function(c){var e=f[c],h=a.getChildren()[c],i;this._searchInProgress=!0;var j=dojo.hitch(this,function(){delete this._searchInProgress});(e||h)&&!this._opened&&this.toggleDropDown();if(e&&h){var k=dojo.hitch(this,function(){i&&this.disconnect(i),delete i;var k=h._menu.getChildren(),l=dojo.filter(k,function(a){return a.label==e})[0],m=dojo.filter(k,function(a){return a.label.indexOf(e)===0})[0];if(l&&(f.length>c+1&&l.children||!l.children))c++,h._menu.onItemClick(l,{type:"internal",stopPropagation:function(){},preventDefault:function(){}}),f[c]?g(c):j();else{h._setSelected(null);if(m&&f.length===c+1){a._setInProgress=!0,a._removeAfter(h),delete a._setInProgress;var n=m.label;m.children&&(n+=a.pathSeparator),n=n.substring(e.length),window.setTimeout(function(){dojo.window.scrollIntoView(m.domNode)},1),b.value=d+n,dijit.selectInputText(b,d.length),this._hasSelection=!0;try{m.focusNode.focus()}catch(o){}}else this._menuFocus&&this.dropDown._updateClass(this._menuFocus,"Item",{Hover:!1,Focus:!1}),delete this._menuFocus;j()}});h.isLoaded?k():i=this.connect(h,"onLoad",k)}else h&&(h._setSelected(null),a._setInProgress=!0,a._removeAfter(h),delete a._setInProgress),j()});g(0)},_onKey:function(a){if(!this.disabled&&!this.readOnly){var b=dojo.keys,c=a.charOrCode;c==b.DOWN_ARROW&&(this._allowBlur=!0);if(c==b.ENTER&&this._opened){this.dropDown.onExecute(),dijit.selectInputText(this.focusNode,this.focusNode.value.length),this._hasSelection=!1,dojo.stopEvent(a);return}if((c==b.RIGHT_ARROW||c==b.LEFT_ARROW||c==b.TAB)&&this._hasSelection){this._startSearchFromInput(),dojo.stopEvent(a);return}this.inherited(arguments);var d=!1;c!=b.BACKSPACE&&c!=b.DELETE||!this._hasSelection?c==b.BACKSPACE||c==b.DELETE||c==" "?d=!0:d=a.keyChar!=="":this._hasSelection=!1,this._searchTimer&&window.clearTimeout(this._searchTimer),delete this._searchTimer,d&&(this._hasValidPath=!1,this._hasSelection=!1,this._searchTimer=window.setTimeout(dojo.hitch(this,"_startSearchFromInput"),this.searchDelay+1))}}})