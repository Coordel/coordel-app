define("dijit/_editor/plugins/EnterKeyHandling",["dojo","dijit","dojo/window","dijit/_editor/_Plugin","dijit/_editor/range"],function(a,b){a.declare("dijit._editor.plugins.EnterKeyHandling",b._editor._Plugin,{blockNodeForEnter:"BR",constructor:function(b){b&&("blockNodeForEnter"in b&&(b.blockNodeForEnter=b.blockNodeForEnter.toUpperCase()),a.mixin(this,b))},setEditor:function(b){if(this.editor!==b){this.editor=b;if(this.blockNodeForEnter=="BR")this.editor.customUndo=!0,b.onLoadDeferred.addCallback(a.hitch(this,function(c){this.connect(b.document,"onkeypress",function(b){if(b.charOrCode==a.keys.ENTER){var c=a.mixin({},b);c.shiftKey=!0,this.handleEnterKey(c)||a.stopEvent(b)}});return c}));else if(this.blockNodeForEnter){var c=a.hitch(this,this.handleEnterKey);b.addKeyHandler(13,0,0,c),b.addKeyHandler(13,0,1,c),this.connect(this.editor,"onKeyPressed","onKeyPressed")}}},onKeyPressed:function(c){if(this._checkListLater){if(a.withGlobal(this.editor.window,"isCollapsed",b)){var d=a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,["LI"]);if(d){a.isMoz&&(d.parentNode.parentNode.nodeName=="LI"&&(d=d.parentNode.parentNode));var g=d.firstChild;if(g&&g.nodeType==1&&(g.nodeName=="UL"||g.nodeName=="OL")){d.insertBefore(g.ownerDocument.createTextNode(" "),g);var h=b.range.create(this.editor.window);h.setStart(d.firstChild,0);var i=b.range.getSelection(this.editor.window,!0);i.removeAllRanges(),i.addRange(h)}}else{b._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var e=a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,[this.blockNodeForEnter]);if(e){e.innerHTML=this.bogusHtmlContent;if(a.isIE){var f=this.editor.document.selection.createRange();f.move("character",-1),f.select()}}else console.error("onKeyPressed: Cannot find the new block node")}}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(c){var d,e,f,g,h,i,j=this.editor.document,k,l,m;if(c.shiftKey){var n=a.withGlobal(this.editor.window,"getParentElement",b._editor.selection),o=b.range.getAncestor(n,this.blockNodes);if(o){if(o.tagName=="LI")return!0;d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0),e.collapsed||(e.deleteContents(),d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0));if(b.range.atBeginningOfContainer(o,e.startContainer,e.startOffset))k=j.createElement("br"),f=b.range.create(this.editor.window),o.insertBefore(k,o.firstChild),f.setStartBefore(k.nextSibling),d.removeAllRanges(),d.addRange(f);else if(b.range.atEndOfContainer(o,e.startContainer,e.startOffset))f=b.range.create(this.editor.window),k=j.createElement("br"),o.appendChild(k),o.appendChild(j.createTextNode(" ")),f.setStart(o.lastChild,0),d.removeAllRanges(),d.addRange(f);else{l=e.startContainer;if(l&&l.nodeType==3){m=l.nodeValue,a.withGlobal(this.editor.window,function(){g=j.createTextNode(m.substring(0,e.startOffset)),h=j.createTextNode(m.substring(e.startOffset)),i=j.createElement("br"),h.nodeValue==""&&a.isWebKit&&(h=j.createTextNode(" ")),a.place(g,l,"after"),a.place(i,g,"after"),a.place(h,i,"after"),a.destroy(l),f=b.range.create(a.gobal),f.setStart(h,0),d.removeAllRanges(),d.addRange(f)});return!1}return!0}}else d=b.range.getSelection(this.editor.window),d.rangeCount?(e=d.getRangeAt(0),e&&e.startContainer&&(e.collapsed||(e.deleteContents(),d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0)),l=e.startContainer,l&&l.nodeType==3?a.withGlobal(this.editor.window,a.hitch(this,function(){var c=!1,k=e.startOffset;l.length<k&&(w=this._adjustNodeAndOffset(l,k),l=w.node,k=w.offset),m=l.nodeValue,g=j.createTextNode(m.substring(0,k)),h=j.createTextNode(m.substring(k)),i=j.createElement("br"),h.length||(h=j.createTextNode(" "),c=!0),g.length?a.place(g,l,"after"):g=l,a.place(i,g,"after"),a.place(h,i,"after"),a.destroy(l),f=b.range.create(a.gobal),f.setStart(h,0),f.setEnd(h,h.length),d.removeAllRanges(),d.addRange(f),c&&!a.isWebKit?b._editor.selection.remove():b._editor.selection.collapse(!0)})):a.withGlobal(this.editor.window,a.hitch(this,function(){var c=j.createElement("br");l.appendChild(c);var e=j.createTextNode(" ");l.appendChild(e),f=b.range.create(a.global),f.setStart(e,0),f.setEnd(e,e.length),d.removeAllRanges(),d.addRange(f),b._editor.selection.collapse(!0)})))):b._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var p=!0;d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0),e.collapsed||(e.deleteContents(),d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0));var q=b.range.getBlockAncestor(e.endContainer,null,this.editor.editNode),r=q.blockNode;if(this._checkListLater=r&&(r.nodeName=="LI"||r.parentNode.nodeName=="LI")){a.isMoz&&(this._pressedEnterInBlock=r),/^(\s|&nbsp;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|\xA0)<\/span>)?(<br>)?$/.test(r.innerHTML)&&(r.innerHTML="",a.isWebKit&&(f=b.range.create(this.editor.window),f.setStart(r,0),d.removeAllRanges(),d.addRange(f)),this._checkListLater=!1);return!0}if(!q.blockNode||q.blockNode===this.editor.editNode){try{b._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(s){}q={blockNode:a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(q.blockNode){if(q.blockNode!=this.editor.editNode&&!(q.blockNode.textContent||q.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length){this.removeTrailingBr(q.blockNode);return!1}}else q.blockNode=this.editor.editNode;d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0)}var t=j.createElement(this.blockNodeForEnter);t.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(q.blockNode);var u=e.endOffset,v=e.endContainer;if(v.length<u){var w=this._adjustNodeAndOffset(v,u);v=w.node,u=w.offset}if(b.range.atEndOfContainer(q.blockNode,v,u))q.blockNode===q.blockContainer?q.blockNode.appendChild(t):a.place(t,q.blockNode,"after"),p=!1,f=b.range.create(this.editor.window),f.setStart(t,0),d.removeAllRanges(),d.addRange(f),this.editor.height&&a.window.scrollIntoView(t);else if(b.range.atBeginningOfContainer(q.blockNode,e.startContainer,e.startOffset))a.place(t,q.blockNode,q.blockNode===q.blockContainer?"first":"before"),t.nextSibling&&this.editor.height&&(f=b.range.create(this.editor.window),f.setStart(t.nextSibling,0),d.removeAllRanges(),d.addRange(f),a.window.scrollIntoView(t.nextSibling)),p=!1;else{q.blockNode===q.blockContainer?q.blockNode.appendChild(t):a.place(t,q.blockNode,"after"),p=!1,q.blockNode.style&&(t.style&&(q.blockNode.style.cssText&&(t.style.cssText=q.blockNode.style.cssText))),l=e.startContainer;var x;if(l&&l.nodeType==3){var y,z;u=e.endOffset,l.length<u&&(w=this._adjustNodeAndOffset(l,u),l=w.node,u=w.offset),m=l.nodeValue,g=j.createTextNode(m.substring(0,u)),h=j.createTextNode(m.substring(u,m.length)),a.place(g,l,"before"),a.place(h,l,"after"),a.destroy(l);var A=g.parentNode;while(A!==q.blockNode){var B=A.tagName,C=j.createElement(B);A.style&&(C.style&&(A.style.cssText&&(C.style.cssText=A.style.cssText))),A.tagName==="FONT"&&(A.color&&(C.color=A.color),A.face&&(C.face=A.face),A.size&&(C.size=A.size)),y=h;while(y)z=y.nextSibling,C.appendChild(y),y=z;a.place(C,A,"after"),g=A,h=C,A=A.parentNode}y=h;if(y.nodeType==1||y.nodeType==3&&y.nodeValue)t.innerHTML="";x=y;while(y)z=y.nextSibling,t.appendChild(y),y=z}f=b.range.create(this.editor.window);var D,E=x;if(this.blockNodeForEnter!=="BR"){while(E)D=E,z=E.firstChild,E=z;D&&D.parentNode?(t=D.parentNode,f.setStart(t,0),d.removeAllRanges(),d.addRange(f),this.editor.height&&b.scrollIntoView(t),a.isMoz&&(this._pressedEnterInBlock=q.blockNode)):p=!0}else f.setStart(t,0),d.removeAllRanges(),d.addRange(f),this.editor.height&&b.scrollIntoView(t),a.isMoz&&(this._pressedEnterInBlock=q.blockNode)}return p},_adjustNodeAndOffset:function(a,b){while(a.length<b&&a.nextSibling&&a.nextSibling.nodeType==3)b=b-a.length,a=a.nextSibling;var c={node:a,offset:b};return c},removeTrailingBr:function(c){var d=/P|DIV|LI/i.test(c.tagName)?c:b._editor.selection.getParentOfType(c,["P","DIV","LI"]);d&&(d.lastChild&&((d.childNodes.length>1&&d.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(d.lastChild.nodeValue)||d.lastChild.tagName=="BR")&&a.destroy(d.lastChild)),d.childNodes.length||(d.innerHTML=this.bogusHtmlContent))}});return b._editor.plugins.EnterKeyHandling})