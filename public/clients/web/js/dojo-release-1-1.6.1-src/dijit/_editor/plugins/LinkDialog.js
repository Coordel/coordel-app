define("dijit/_editor/plugins/LinkDialog",["dojo","dijit","dijit/_Widget","dijit/_editor/_Plugin","dijit/TooltipDialog","dijit/form/DropDownButton","dijit/form/ValidationTextBox","dijit/form/Select","dijit/_editor/range","dojo/i18n","dojo/string","i18n!dijit/nls/common","i18n!dijit/_editor/nls/LinkDialog"],function(a,b){a.declare("dijit._editor.plugins.LinkDialog",b._editor._Plugin,{buttonClass:b.form.DropDownButton,useDefaultCommand:!1,urlRegExp:"((https?|ftps?|file)\\://|./|/|)(/[a-zA-Z]{1,1}:/|)(((?:(?:[\\da-zA-Z](?:[-\\da-zA-Z]{0,61}[\\da-zA-Z])?)\\.)*(?:[a-zA-Z](?:[-\\da-zA-Z]{0,80}[\\da-zA-Z])?)\\.?)|(((\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.){3}(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])|(0[xX]0*[\\da-fA-F]?[\\da-fA-F]\\.){3}0[xX]0*[\\da-fA-F]?[\\da-fA-F]|(0+[0-3][0-7][0-7]\\.){3}0+[0-3][0-7][0-7]|(0|[1-9]\\d{0,8}|[1-3]\\d{9}|4[01]\\d{8}|42[0-8]\\d{7}|429[0-3]\\d{6}|4294[0-8]\\d{5}|42949[0-5]\\d{4}|429496[0-6]\\d{3}|4294967[01]\\d{2}|42949672[0-8]\\d|429496729[0-5])|0[xX]0*[\\da-fA-F]{1,8}|([\\da-fA-F]{1,4}\\:){7}[\\da-fA-F]{1,4}|([\\da-fA-F]{1,4}\\:){6}((\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.){3}(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])))(\\:\\d+)?(/(?:[^?#\\s/]+/)*(?:[^?#\\s/]{0,}(?:\\?[^?#\\s/]*)?(?:#.*)?)?)?",emailRegExp:"<?(mailto\\:)([!#-'*+\\-\\/-9=?A-Z^-~]+[.])*[!#-'*+\\-\\/-9=?A-Z^-~]+@((?:(?:[\\da-zA-Z](?:[-\\da-zA-Z]{0,61}[\\da-zA-Z])?)\\.)+(?:[a-zA-Z](?:[-\\da-zA-Z]{0,6}[\\da-zA-Z])?)\\.?)|localhost|^[^-][a-zA-Z0-9_-]*>?",htmlTemplate:'<a href="${urlInput}" _djrealurl="${urlInput}" target="${targetSelect}">${textInput}</a>',tag:"a",_hostRxp:new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$"),_userAtRxp:new RegExp("^([!#-'*+\\-\\/-9=?A-Z^-~]+[.])*[!#-'*+\\-\\/-9=?A-Z^-~]+@","i"),linkDialogTemplate:["<table><tr><td>","<label for='${id}_urlInput'>${url}</label>","</td><td>","<input dojoType='dijit.form.ValidationTextBox' required='true' id='${id}_urlInput' name='urlInput' intermediateChanges='true'/>","</td></tr><tr><td>","<label for='${id}_textInput'>${text}</label>","</td><td>","<input dojoType='dijit.form.ValidationTextBox' required='true' id='${id}_textInput' name='textInput' intermediateChanges='true'/>","</td></tr><tr><td>","<label for='${id}_targetSelect'>${target}</label>","</td><td>","<select id='${id}_targetSelect' name='targetSelect' dojoType='dijit.form.Select'>","<option selected='selected' value='_self'>${currentWindow}</option>","<option value='_blank'>${newWindow}</option>","<option value='_top'>${topWindow}</option>","<option value='_parent'>${parentWindow}</option>","</select>","</td></tr><tr><td colspan='2'>","<button dojoType='dijit.form.Button' type='submit' id='${id}_setButton'>${set}</button>","<button dojoType='dijit.form.Button' type='button' id='${id}_cancelButton'>${buttonCancel}</button>","</td></tr></table>"].join(""),_initButton:function(){var c=this;this.tag=this.command=="insertImage"?"img":"a";var d=a.mixin(a.i18n.getLocalization("dijit","common",this.lang),a.i18n.getLocalization("dijit._editor","LinkDialog",this.lang)),e=this.dropDown=new b.TooltipDialog({title:d[this.command+"Title"],execute:a.hitch(this,"setValue"),onOpen:function(){c._onOpenDialog(),b.TooltipDialog.prototype.onOpen.apply(this,arguments)},onCancel:function(){setTimeout(a.hitch(c,"_onCloseDialog"),0)}});d.urlRegExp=this.urlRegExp,d.id=b.getUniqueId(this.editor.id),this._uniqueId=d.id,this._setContent(e.title+"<div style='border-bottom: 1px black solid;padding-bottom:2pt;margin-bottom:4pt'></div>"+a.string.substitute(this.linkDialogTemplate,d)),e.startup(),this._urlInput=b.byId(this._uniqueId+"_urlInput"),this._textInput=b.byId(this._uniqueId+"_textInput"),this._setButton=b.byId(this._uniqueId+"_setButton"),this.connect(b.byId(this._uniqueId+"_cancelButton"),"onClick",function(){this.dropDown.onCancel()}),this._urlInput&&this.connect(this._urlInput,"onChange","_checkAndFixInput"),this._textInput&&this.connect(this._textInput,"onChange","_checkAndFixInput"),this._urlRegExp=new RegExp("^"+this.urlRegExp+"$","i"),this._emailRegExp=new RegExp("^"+this.emailRegExp+"$","i"),this._urlInput.isValid=a.hitch(this,function(){var a=this._urlInput.get("value");return this._urlRegExp.test(a)||this._emailRegExp.test(a)}),this._connectTagEvents(),this.inherited(arguments)},_checkAndFixInput:function(){var b=this,c=this._urlInput.get("value"),d=function(c){var d=!1,e=!1;c&&c.length>1&&(c=a.trim(c),c.indexOf("mailto:")!==0&&(c.indexOf("/")>0?c.indexOf("://")===-1&&(c.charAt(0)!=="/"&&c.indexOf("./")!==0&&(b._hostRxp.test(c)&&(d=!0))):b._userAtRxp.test(c)&&(e=!0))),d&&b._urlInput.set("value","http://"+c),e&&b._urlInput.set("value","mailto:"+c),b._setButton.set("disabled",!b._isValid())};this._delayedCheck&&(clearTimeout(this._delayedCheck),this._delayedCheck=null),this._delayedCheck=setTimeout(function(){d(c)},250)},_connectTagEvents:function(){this.editor.onLoadDeferred.addCallback(a.hitch(this,function(){this.connect(this.editor.editNode,"ondblclick",this._onDblClick)}))},_isValid:function(){return this._urlInput.isValid()&&this._textInput.isValid()},_setContent:function(a){this.dropDown.set({parserScope:"dojo",content:a})},_checkValues:function(a){a&&a.urlInput&&(a.urlInput=a.urlInput.replace(/"/g,"&quot;"));return a},setValue:function(c){this._onCloseDialog();if(a.isIE<9){var d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0),f=e.endContainer;f.nodeType===3&&(f=f.parentNode),f&&(f.nodeName&&f.nodeName.toLowerCase()!==this.tag)&&(f=a.withGlobal(this.editor.window,"getSelectedElement",b._editor.selection,[this.tag])),f&&(f.nodeName&&f.nodeName.toLowerCase()===this.tag)&&(this.editor.queryCommandEnabled("unlink")&&(a.withGlobal(this.editor.window,"selectElementChildren",b._editor.selection,[f]),this.editor.execCommand("unlink")))}c=this._checkValues(c),this.editor.execCommand("inserthtml",a.string.substitute(this.htmlTemplate,c))},_onCloseDialog:function(){this.editor.focus()},_getCurrentValues:function(c){var d,e,f;c&&c.tagName.toLowerCase()===this.tag?(d=c.getAttribute("_djrealurl")||c.getAttribute("href"),f=c.getAttribute("target")||"_self",e=c.textContent||c.innerText,a.withGlobal(this.editor.window,"selectElement",b._editor.selection,[c,!0])):e=a.withGlobal(this.editor.window,b._editor.selection.getSelectedText);return{urlInput:d||"",textInput:e||"",targetSelect:f||""}},_onOpenDialog:function(){var c;if(a.isIE<9){var d=b.range.getSelection(this.editor.window),e=d.getRangeAt(0);c=e.endContainer,c.nodeType===3&&(c=c.parentNode),c&&(c.nodeName&&c.nodeName.toLowerCase()!==this.tag)&&(c=a.withGlobal(this.editor.window,"getSelectedElement",b._editor.selection,[this.tag]))}else c=a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,[this.tag]);this.dropDown.reset(),this._setButton.set("disabled",!0),this.dropDown.set("value",this._getCurrentValues(c))},_onDblClick:function(c){if(c&&c.target){var d=c.target,e=d.tagName?d.tagName.toLowerCase():"";e===this.tag&&a.attr(d,"href")&&(a.withGlobal(this.editor.window,"selectElement",b._editor.selection,[d]),this.editor.onDisplayChanged(),setTimeout(a.hitch(this,function(){this.button.set("disabled",!1),this.button.openDropDown()}),10))}}}),a.declare("dijit._editor.plugins.ImgLinkDialog",[b._editor.plugins.LinkDialog],{linkDialogTemplate:["<table><tr><td>","<label for='${id}_urlInput'>${url}</label>","</td><td>","<input dojoType='dijit.form.ValidationTextBox' regExp='${urlRegExp}' required='true' id='${id}_urlInput' name='urlInput' intermediateChanges='true'/>","</td></tr><tr><td>","<label for='${id}_textInput'>${text}</label>","</td><td>","<input dojoType='dijit.form.ValidationTextBox' required='false' id='${id}_textInput' name='textInput' intermediateChanges='true'/>","</td></tr><tr><td>","</td><td>","</td></tr><tr><td colspan='2'>","<button dojoType='dijit.form.Button' type='submit' id='${id}_setButton'>${set}</button>","<button dojoType='dijit.form.Button' type='button' id='${id}_cancelButton'>${buttonCancel}</button>","</td></tr></table>"].join(""),htmlTemplate:'<img src="${urlInput}" _djrealurl="${urlInput}" alt="${textInput}" />',tag:"img",_getCurrentValues:function(c){var d,e;c&&c.tagName.toLowerCase()===this.tag?(d=c.getAttribute("_djrealurl")||c.getAttribute("src"),e=c.getAttribute("alt"),a.withGlobal(this.editor.window,"selectElement",b._editor.selection,[c,!0])):e=a.withGlobal(this.editor.window,b._editor.selection.getSelectedText);return{urlInput:d||"",textInput:e||""}},_isValid:function(){return this._urlInput.isValid()},_connectTagEvents:function(){this.inherited(arguments),this.editor.onLoadDeferred.addCallback(a.hitch(this,function(){this.connect(this.editor.editNode,"onmousedown",this._selectTag)}))},_selectTag:function(c){if(c&&c.target){var d=c.target,e=d.tagName?d.tagName.toLowerCase():"";e===this.tag&&a.withGlobal(this.editor.window,"selectElement",b._editor.selection,[d])}},_checkValues:function(a){a&&a.urlInput&&(a.urlInput=a.urlInput.replace(/"/g,"&quot;")),a&&a.textInput&&(a.textInput=a.textInput.replace(/"/g,"&quot;"));return a},_onDblClick:function(c){if(c&&c.target){var d=c.target,e=d.tagName?d.tagName.toLowerCase():"";e===this.tag&&a.attr(d,"src")&&(a.withGlobal(this.editor.window,"selectElement",b._editor.selection,[d]),this.editor.onDisplayChanged(),setTimeout(a.hitch(this,function(){this.button.set("disabled",!1),this.button.openDropDown()}),10))}}}),a.subscribe(b._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin)switch(a.args.name){case"createLink":a.plugin=new b._editor.plugins.LinkDialog({command:a.args.name});break;case"insertImage":a.plugin=new b._editor.plugins.ImgLinkDialog({command:a.args.name})}});return b._editor.plugins.LinkDialog})