define("dijit/_editor/plugins/ViewSource",["dojo","dijit","dojo/window","dojo/i18n","dijit/_editor/_Plugin","dijit/form/Button","i18n!dijit/_editor/nls/commands"],function(a,b){a.declare("dijit._editor.plugins.ViewSource",b._editor._Plugin,{stripScripts:!0,stripComments:!0,stripIFrames:!0,readOnly:!1,_fsPlugin:null,toggle:function(){a.isWebKit&&(this._vsFocused=!0),this.button.set("checked",!this.button.get("checked"))},_initButton:function(){var c=a.i18n.getLocalization("dijit._editor","commands"),d=this.editor;this.button=new b.form.ToggleButton({label:c.viewSource,dir:d.dir,lang:d.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:a.hitch(this,"_showSource")}),a.isIE==7&&(this._ieFixNode=a.create("div",{style:{opacity:"0",zIndex:"-1000",position:"absolute",top:"-1000px"}},a.body())),this.button.set("readOnly",!1)},setEditor:function(b){this.editor=b,this._initButton(),this.editor.addKeyHandler(a.keys.F12,!0,!0,a.hitch(this,function(b){this.button.focus(),this.toggle(),a.stopEvent(b),setTimeout(a.hitch(this,function(){this.editor.focus()}),100)}))},_showSource:function(c){var d=this.editor,e=d._plugins,f;this._sourceShown=c;var g=this;try{this.sourceArea||this._createSourceView();if(c){d._sourceQueryCommandEnabled=d.queryCommandEnabled,d.queryCommandEnabled=function(a){var b=a.toLowerCase();return b==="viewsource"?!0:!1},this.editor.onDisplayChanged(),f=d.get("value"),f=this._filter(f),d.set("value",f),this._pluginList=[],a.forEach(e,function(a){a instanceof b._editor.plugins.ViewSource||a.set("disabled",!0)}),this._fsPlugin&&(this._fsPlugin._getAltViewNode=function(){return g.sourceArea}),this.sourceArea.value=f;var h=a._getMarginSize(d.iframe.parentNode);a.marginBox(this.sourceArea,{w:h.w,h:h.h}),a.style(d.iframe,"display","none"),a.style(this.sourceArea,{display:"block"});var i=function(){var b=a.window.getBox();if("_prevW"in this&&"_prevH"in this){if(b.w===this._prevW&&b.h===this._prevH)return;this._prevW=b.w,this._prevH=b.h}else this._prevW=b.w,this._prevH=b.h;this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizer=setTimeout(a.hitch(this,function(){delete this._resizer,this._resize()}),10)};this._resizeHandle=a.connect(window,"onresize",this,i),setTimeout(a.hitch(this,this._resize),100),this.editor.onNormalizedDisplayChanged(),this.editor.__oldGetValue=this.editor.getValue,this.editor.getValue=a.hitch(this,function(){var a=this.sourceArea.value;a=this._filter(a);return a})}else{if(!d._sourceQueryCommandEnabled)return;a.disconnect(this._resizeHandle),delete this._resizeHandle,this.editor.__oldGetValue&&(this.editor.getValue=this.editor.__oldGetValue,delete this.editor.__oldGetValue),d.queryCommandEnabled=d._sourceQueryCommandEnabled,this._readOnly||(f=this.sourceArea.value,f=this._filter(f),d.beginEditing(),d.set("value",f),d.endEditing()),a.forEach(e,function(a){a.set("disabled",!1)}),a.style(this.sourceArea,"display","none"),a.style(d.iframe,"display","block"),delete d._sourceQueryCommandEnabled,this.editor.onDisplayChanged()}setTimeout(a.hitch(this,function(){var a=d.domNode.parentNode;if(a){var c=b.getEnclosingWidget(a);c&&c.resize&&c.resize()}d.resize()}),300)}catch(j){console.log(j)}},updateState:function(){this.button.set("disabled",this.get("disabled"))},_resize:function(){var b=this.editor,c=b.getHeaderHeight(),d=b.getFooterHeight(),e=a.position(b.domNode),f=a._getPadBorderExtents(b.iframe.parentNode),g=a._getMarginExtents(b.iframe.parentNode),h=a._getPadBorderExtents(b.domNode),i=a._getMarginExtents(b.domNode),j={w:e.w-(h.w+i.w),h:e.h-(c+h.h+i.h+d)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var k=a.window.getBox();j.w=k.w-h.w,j.h=k.h-(c+h.h+d)}a.isIE&&(j.h-=2);if(this._ieFixNode){var l=-this._ieFixNode.offsetTop/1e3;j.w=Math.floor((j.w+.9)/l),j.h=Math.floor((j.h+.9)/l)}a.marginBox(this.sourceArea,{w:j.w-(f.w+g.w),h:j.h-(f.h+g.h)}),a.marginBox(b.iframe.parentNode,{h:j.h})},_createSourceView:function(){var c=this.editor,d=c._plugins;this.sourceArea=a.create("textarea"),this.readOnly&&(a.attr(this.sourceArea,"readOnly",!0),this._readOnly=!0),a.style(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),a.place(this.sourceArea,c.iframe,"before"),a.isIE&&c.iframe.parentNode.lastChild!==c.iframe&&a.style(c.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),c._viewsource_oldFocus=c.focus;var e=this;c.focus=function(){if(e._sourceShown)e.setSourceAreaCaret();else try{this._vsFocused?(delete this._vsFocused,b.focus(c.editNode)):c._viewsource_oldFocus()}catch(a){console.log(a)}};var f,g;for(f=0;f<d.length;f++){g=d[f];if(g&&(g.declaredClass==="dijit._editor.plugins.FullScreen"||g.declaredClass===b._scopeName+"._editor.plugins.FullScreen")){this._fsPlugin=g;break}}this._fsPlugin&&(this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode,this._fsPlugin._getAltViewNode=function(){return e._sourceShown?e.sourceArea:this._viewsource_getAltViewNode()}),this.connect(this.sourceArea,"onkeydown",a.hitch(this,function(b){this._sourceShown&&b.keyCode==a.keys.F12&&b.ctrlKey&&b.shiftKey&&(this.button.focus(),this.button.set("checked",!1),setTimeout(a.hitch(this,function(){c.focus()}),100),a.stopEvent(b))}))},_stripScripts:function(a){a&&(a=a.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/ig,""),a=a.replace(/<\s*script\b([^<>]|\s)*>?/ig,""),a=a.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/ig,""));return a},_stripComments:function(a){a&&(a=a.replace(/<!--(.|\s){1,}?-->/g,""));return a},_stripIFrames:function(a){a&&(a=a.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/ig,""));return a},_filter:function(a){a&&(this.stripScripts&&(a=this._stripScripts(a)),this.stripComments&&(a=this._stripComments(a)),this.stripIFrames&&(a=this._stripIFrames(a)));return a},setSourceAreaCaret:function(){var c=a.global,d=this.sourceArea;b.focus(d);if(this._sourceShown&&!this.readOnly)if(a.isIE){if(this.sourceArea.createTextRange){var e=d.createTextRange();e.collapse(!0),e.moveStart("character",-99999),e.moveStart("character",0),e.moveEnd("character",0),e.select()}}else c.getSelection&&(d.setSelectionRange&&d.setSelectionRange(0,0))},destroy:function(){this._ieFixNode&&a.body().removeChild(this._ieFixNode),this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizeHandle&&(a.disconnect(this._resizeHandle),delete this._resizeHandle),this.inherited(arguments)}}),a.subscribe(b._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin){var c=a.args.name.toLowerCase();c==="viewsource"&&(a.plugin=new b._editor.plugins.ViewSource({readOnly:"readOnly"in a.args?a.args.readOnly:!1,stripComments:"stripComments"in a.args?a.args.stripComments:!0,stripScripts:"stripScripts"in a.args?a.args.stripScripts:!0,stripIFrames:"stripIFrames"in a.args?a.args.stripIFrames:!0}))}});return b._editor.plugins.ViewSource})