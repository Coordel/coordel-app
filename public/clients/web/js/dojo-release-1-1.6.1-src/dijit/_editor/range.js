define("dijit/_editor/range",["dojo","dijit"],function(a,b){b.range={},b.range.getIndex=function(a,b){var c=[],d=[],e=b,f=a,g,h;while(a!=e){var i=0;g=a.parentNode;while(h=g.childNodes[i++])if(h===a){--i;break}c.unshift(i),d.unshift(i-g.childNodes.length),a=g}if(c.length>0&&f.nodeType==3){h=f.previousSibling;while(h&&h.nodeType==3)c[c.length-1]--,h=h.previousSibling;h=f.nextSibling;while(h&&h.nodeType==3)d[d.length-1]++,h=h.nextSibling}return{o:c,r:d}},b.range.getNode=function(b,c){if(!a.isArray(b)||b.length==0)return c;var d=c;a.every(b,function(a){if(a>=0&&a<d.childNodes.length)d=d.childNodes[a];else{d=null;return!1}return!0});return d},b.range.getCommonAncestor=function(a,b,c){c=c||a.ownerDocument.body;var d=function(a){var b=[];while(a){b.unshift(a);if(a!==c)a=a.parentNode;else break}return b},e=d(a),f=d(b),g=Math.min(e.length,f.length),h=e[0];for(var i=1;i<g;i++)if(e[i]===f[i])h=e[i];else break;return h},b.range.getAncestor=function(a,b,c){c=c||a.ownerDocument.body;while(a&&a!==c){var d=a.nodeName.toUpperCase();if(b.test(d))return a;a=a.parentNode}return null},b.range.BlockTagNames=/^(?:P|DIV|H1|H2|H3|H4|H5|H6|ADDRESS|PRE|OL|UL|LI|DT|DE)$/,b.range.getBlockAncestor=function(a,c,d){d=d||a.ownerDocument.body,c=c||b.range.BlockTagNames;var e=null,f;while(a&&a!==d){var g=a.nodeName.toUpperCase();!e&&c.test(g)&&(e=a),!f&&/^(?:BODY|TD|TH|CAPTION)$/.test(g)&&(f=a),a=a.parentNode}return{blockNode:e,blockContainer:f||a.ownerDocument.body}},b.range.atBeginningOfContainer=function(a,b,c){var d=!1,e=c==0;!e&&b.nodeType==3&&(/^[\s\xA0]+$/.test(b.nodeValue.substr(0,c))&&(e=!0));if(e){var f=b;d=!0;while(f&&f!==a){if(f.previousSibling){d=!1;break}f=f.parentNode}}return d},b.range.atEndOfContainer=function(a,b,c){var d=!1,e=c==(b.length||b.childNodes.length);!e&&b.nodeType==3&&(/^[\s\xA0]+$/.test(b.nodeValue.substr(c))&&(e=!0));if(e){var f=b;d=!0;while(f&&f!==a){if(f.nextSibling){d=!1;break}f=f.parentNode}}return d},b.range.adjacentNoneTextNode=function(a,b){var c=a,d=0-a.length||0,e=b?"nextSibling":"previousSibling";while(c){if(c.nodeType!=3)break;d+=c.length,c=c[e]}return[c,d]},b.range._w3c=Boolean(window.getSelection),b.range.create=function(c){return b.range._w3c?(c||a.global).document.createRange():new b.range.W3CRange},b.range.getSelection=function(a,c){if(b.range._w3c)return a.getSelection();var d=new b.range.ie.selection(a);c||d._getCurrentSelection();return d},b.range._w3c||(b.range.ie={cachedSelection:{},selection:function(a){this._ranges=[],this.addRange=function(a,b){this._ranges.push(a),b||a._select(),this.rangeCount=this._ranges.length},this.removeAllRanges=function(){this._ranges=[],this.rangeCount=0};var c=function(){var c=a.document.selection.createRange(),d=a.document.selection.type.toUpperCase();return d=="CONTROL"?new b.range.W3CRange(b.range.ie.decomposeControlRange(c)):new b.range.W3CRange(b.range.ie.decomposeTextRange(c))};this.getRangeAt=function(a){return this._ranges[a]},this._getCurrentSelection=function(){this.removeAllRanges();var a=c();a&&this.addRange(a,!0)}},decomposeControlRange:function(a){var c=a.item(0),d=a.item(a.length-1),e=c.parentNode,f=d.parentNode,g=b.range.getIndex(c,e).o,h=b.range.getIndex(d,f).o+1;return[e,g,f,h]},getEndPoint:function(c,d){var e=c.duplicate();e.collapse(!d);var f="EndTo"+(d?"End":"Start"),g=e.parentElement(),h,i,j;g.childNodes.length>0?a.every(g.childNodes,function(a,d){var k;if(a.nodeType!=3){e.moveToElementText(a);if(e.compareEndPoints(f,c)>0)if(j&&j.nodeType==3)h=j,k=!0;else{h=g,i=d;return!1}else if(d==g.childNodes.length-1){h=g,i=g.childNodes.length;return!1}}else d==g.childNodes.length-1&&(h=a,k=!0);if(k&&h){var l=b.range.adjacentNoneTextNode(h)[0];l?h=l.nextSibling:h=g.firstChild;var m=b.range.adjacentNoneTextNode(h);l=m[0];var n=m[1];l?(e.moveToElementText(l),e.collapse(!1)):e.moveToElementText(g),e.setEndPoint(f,c),i=e.text.length-n;return!1}j=a;return!0}):(h=g,i=0);if(!d&&h.nodeType==1&&i==h.childNodes.length){var k=h.nextSibling;k&&k.nodeType==3&&(h=k,i=0)}return[h,i]},setEndPoint:function(a,c,d){var e=a.duplicate(),f,g;if(c.nodeType!=3)if(d>0){f=c.childNodes[d-1];if(f)if(f.nodeType==3)c=f,d=f.length;else if(f.nextSibling&&f.nextSibling.nodeType==3)c=f.nextSibling,d=0;else{e.moveToElementText(f.nextSibling?f:c);var h=f.parentNode,i=h.insertBefore(f.ownerDocument.createTextNode(" "),f.nextSibling);e.collapse(!1),h.removeChild(i)}}else e.moveToElementText(c),e.collapse(!0);if(c.nodeType==3){var j=b.range.adjacentNoneTextNode(c),k=j[0];g=j[1],k?(e.moveToElementText(k),e.collapse(!1),k.contentEditable!="inherit"&&g++):(e.moveToElementText(c.parentNode),e.collapse(!0)),d+=g,d>0&&(e.move("character",d)!=d&&console.error("Error when moving!"))}return e},decomposeTextRange:function(a){var c=b.range.ie.getEndPoint(a),d=c[0],e=c[1],f=c[0],g=c[1];a.htmlText.length&&(a.htmlText==a.text?g=e+a.text.length:(c=b.range.ie.getEndPoint(a,!0),f=c[0],g=c[1]));return[d,e,f,g]},setRange:function(a,c,d,e,f,g){var h=b.range.ie.setEndPoint(a,c,d);a.setEndPoint("StartToStart",h);if(!g)var i=b.range.ie.setEndPoint(a,e,f);a.setEndPoint("EndToEnd",i||h);return a}},a.declare("dijit.range.W3CRange",null,{constructor:function(){arguments.length>0?(this.setStart(arguments[0][0],arguments[0][1]),this.setEnd(arguments[0][2],arguments[0][3])):(this.commonAncestorContainer=null,this.startContainer=null,this.startOffset=0,this.endContainer=null,this.endOffset=0,this.collapsed=!0)},_updateInternal:function(){this.startContainer!==this.endContainer?this.commonAncestorContainer=b.range.getCommonAncestor(this.startContainer,this.endContainer):this.commonAncestorContainer=this.startContainer,this.collapsed=this.startContainer===this.endContainer&&this.startOffset==this.endOffset},setStart:function(a,b){b=parseInt(b);if(this.startContainer!==a||this.startOffset!=b)delete this._cachedBookmark,this.startContainer=a,this.startOffset=b,this.endContainer?this._updateInternal():this.setEnd(a,b)},setEnd:function(a,b){b=parseInt(b);if(this.endContainer!==a||this.endOffset!=b)delete this._cachedBookmark,this.endContainer=a,this.endOffset=b,this.startContainer?this._updateInternal():this.setStart(a,b)},setStartAfter:function(a,b){this._setPoint("setStart",a,b,1)},setStartBefore:function(a,b){this._setPoint("setStart",a,b,0)},setEndAfter:function(a,b){this._setPoint("setEnd",a,b,1)},setEndBefore:function(a,b){this._setPoint("setEnd",a,b,0)},_setPoint:function(a,c,d,e){var f=b.range.getIndex(c,c.parentNode).o;this[a](c.parentNode,f.pop()+e)},_getIERange:function(){var a=(this._body||this.endContainer.ownerDocument.body).createTextRange();b.range.ie.setRange(a,this.startContainer,this.startOffset,this.endContainer,this.endOffset,this.collapsed);return a},getBookmark:function(a){this._getIERange();return this._cachedBookmark},_select:function(){var a=this._getIERange();a.select()},deleteContents:function(){var a=this._getIERange();a.pasteHTML(""),this.endContainer=this.startContainer,this.endOffset=this.startOffset,this.collapsed=!0},cloneRange:function(){var a=new b.range.W3CRange([this.startContainer,this.startOffset,this.endContainer,this.endOffset]);a._body=this._body;return a},detach:function(){this._body=null,this.commonAncestorContainer=null,this.startContainer=null,this.startOffset=0,this.endContainer=null,this.endOffset=0,this.collapsed=!0}}));return b.range})