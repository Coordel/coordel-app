define("dijit/form/ComboBox",["dojo","dijit","text!dijit/form/templates/DropDownBox.html","dojo/window","dojo/regexp","dojo/data/util/simpleFetch","dojo/data/util/filter","dijit/_CssStateMixin","dijit/form/_FormWidget","dijit/form/ValidationTextBox","dijit/_HasDropDown","i18n!dijit/form/nls/ComboBox"],function(a,b){a.declare("dijit.form.ComboBoxMixin",b._HasDropDown,{item:null,pageSize:Infinity,store:null,fetchProperties:{},query:{},autoComplete:!0,highlightMatch:"first",searchDelay:100,searchAttr:"name",labelAttr:"",labelType:"text",queryExpr:"${0}*",ignoreCase:!0,hasDownArrow:!0,templateString:a.cache("dijit.form","templates/DropDownBox.html"),baseClass:"dijitTextBox dijitComboBox",dropDownClass:"dijit.form._ComboBoxMenu",cssStateNodes:{_buttonNode:"dijitDownArrowButton"},maxHeight:-1,_stopClickEvents:!1,_getCaretPos:function(b){var c=0;if(typeof b.selectionStart=="number")c=b.selectionStart;else if(a.isIE){var d=a.doc.selection.createRange().duplicate(),e=b.createTextRange();d.move("character",0),e.move("character",0);try{e.setEndPoint("EndToEnd",d),c=String(e.text).replace(/\r/g,"").length}catch(f){}}return c},_setCaretPos:function(a,c){c=parseInt(c),b.selectInputText(a,c,c)},_setDisabledAttr:function(a){this.inherited(arguments),b.setWaiState(this.domNode,"disabled",a)},_abortQuery:function(){this.searchTimer&&(clearTimeout(this.searchTimer),this.searchTimer=null),this._fetchHandle&&(this._fetchHandle.abort&&this._fetchHandle.abort(),this._fetchHandle=null)},_onInput:function(b){!this.searchTimer&&(b.type=="paste"||b.type=="input")&&this._lastInput!=this.textbox.value&&(this.searchTimer=setTimeout(a.hitch(this,function(){this._onKey({charOrCode:229})}),100)),this.inherited(arguments)},_onKey:function(b){var c=b.charOrCode;if(!(b.altKey||(b.ctrlKey||b.metaKey)&&(c!="x"&&c!="v")||c==a.keys.SHIFT)){var d=!1,e=this.dropDown,f=a.keys,g=null;this._prev_key_backspace=!1,this._abortQuery(),this.inherited(arguments),this._opened&&(g=e.getHighlightedOption());switch(c){case f.PAGE_DOWN:case f.DOWN_ARROW:case f.PAGE_UP:case f.UP_ARROW:this._opened&&this._announceOption(g),a.stopEvent(b);break;case f.ENTER:if(g){if(g==e.nextButton){this._nextSearch(1),a.stopEvent(b);break}if(g==e.previousButton){this._nextSearch(-1),a.stopEvent(b);break}}else this._setBlurValue(),this._setCaretPos(this.focusNode,this.focusNode.value.length);(this._opened||this._fetchHandle)&&b.preventDefault();case f.TAB:var h=this.get("displayedValue");if(e&&(h==e._messages.previousMessage||h==e._messages.nextMessage))break;g&&this._selectOption(),this._opened&&(this._lastQuery=null,this.closeDropDown());break;case" ":g?(a.stopEvent(b),this._selectOption(),this.closeDropDown()):d=!0;break;case f.DELETE:case f.BACKSPACE:this._prev_key_backspace=!0,d=!0;break;default:d=typeof c=="string"||c==229}d&&(this.item=undefined,this.searchTimer=setTimeout(a.hitch(this,"_startSearchFromInput"),1))}},_autoCompleteText:function(a){var c=this.focusNode;b.selectInputText(c,c.value.length);var d=this.ignoreCase?"toLowerCase":"substr";if(a[d](0).indexOf(this.focusNode.value[d](0))==0){var e=this._getCaretPos(c);e+1>c.value.length&&(c.value=a,b.selectInputText(c,e))}else c.value=a,b.selectInputText(c)},_openResultList:function(b,c){this._fetchHandle=null;if(!this.disabled&&!this.readOnly&&c.query[this.searchAttr]==this._lastQuery){var d=this.dropDown._highlighted_option&&a.hasClass(this.dropDown._highlighted_option,"dijitMenuItemSelected");this.dropDown.clearResultList();if(!b.length&&!this._maxOptions){this.closeDropDown();return}c._maxOptions=this._maxOptions;var e=this.dropDown.createOptions(b,c,a.hitch(this,"_getMenuLabelFromItem"));this._showResultList(),c.direction?(1==c.direction?this.dropDown.highlightFirstOption():-1==c.direction&&this.dropDown.highlightLastOption(),d&&this._announceOption(this.dropDown.getHighlightedOption())):this.autoComplete&&!this._prev_key_backspace&&!/^[*]+$/.test(c.query[this.searchAttr])&&this._announceOption(e[1])}},_showResultList:function(){this.closeDropDown(!0),this.displayMessage(""),this.openDropDown(),b.setWaiState(this.domNode,"expanded","true")},loadDropDown:function(a){this._startSearchAll()},isLoaded:function(){return!1},closeDropDown:function(){this._abortQuery(),this._opened&&(this.inherited(arguments),b.setWaiState(this.domNode,"expanded","false"),b.removeWaiState(this.focusNode,"activedescendant"))},_setBlurValue:function(){var a=this.get("displayedValue"),c=this.dropDown;!c||a!=c._messages.previousMessage&&a!=c._messages.nextMessage?typeof this.item=="undefined"?(this.item=null,this.set("displayedValue",a)):(this.value!=this._lastValueReported&&b.form._FormValueWidget.prototype._setValueAttr.call(this,this.value,!0),this._refreshState()):this._setValueAttr(this._lastValueReported,!0)},_onBlur:function(){this.closeDropDown(),this.inherited(arguments)},_setItemAttr:function(a,c,d){d||(d=this.store.getValue(a,this.searchAttr));var e=this._getValueField()!=this.searchAttr?this.store.getIdentity(a):d;this._set("item",a),b.form.ComboBox.superclass._setValueAttr.call(this,e,c,d)},_announceOption:function(c){if(c){var d;c==this.dropDown.nextButton||c==this.dropDown.previousButton?(d=c.innerHTML,this.item=undefined,this.value=""):(d=this.store.getValue(c.item,this.searchAttr).toString(),this.set("item",c.item,!1,d)),this.focusNode.value=this.focusNode.value.substring(0,this._lastInput.length),b.setWaiState(this.focusNode,"activedescendant",a.attr(c,"id")),this._autoCompleteText(d)}},_selectOption:function(a){a&&this._announceOption(a.target),this.closeDropDown(),this._setCaretPos(this.focusNode,this.focusNode.value.length),b.form._FormValueWidget.prototype._setValueAttr.call(this,this.value,!0)},_startSearchAll:function(){this._startSearch("")},_startSearchFromInput:function(){this._startSearch(this.focusNode.value.replace(/([\\\*\?])/g,"\\$1"))},_getQueryString:function(b){return a.string.substitute(this.queryExpr,[b])},_startSearch:function(c){if(!this.dropDown){var d=this.id+"_popup",e=a.getObject(this.dropDownClass,!1);this.dropDown=new e({onChange:a.hitch(this,this._selectOption),id:d,dir:this.dir}),b.removeWaiState(this.focusNode,"activedescendant"),b.setWaiState(this.textbox,"owns",d)}var f=a.clone(this.query);this._lastInput=c,this._lastQuery=f[this.searchAttr]=this._getQueryString(c),this.searchTimer=setTimeout(a.hitch(this,function(b,c){this.searchTimer=null;var d={queryOptions:{ignoreCase:this.ignoreCase,deep:!0},query:b,onBegin:a.hitch(this,"_setMaxOptions"),onComplete:a.hitch(this,"_openResultList"),onError:function(a){c._fetchHandle=null,console.error("dijit.form.ComboBox: "+a),c.closeDropDown()},start:0,count:this.pageSize};a.mixin(d,c.fetchProperties),this._fetchHandle=c.store.fetch(d);var e=function(a,b){a.start+=a.count*b,a.direction=b,this._fetchHandle=this.store.fetch(a),this.focus()};this._nextSearch=this.dropDown.onPage=a.hitch(this,e,this._fetchHandle)},f,this),this.searchDelay)},_setMaxOptions:function(a,b){this._maxOptions=a},_getValueField:function(){return this.searchAttr},constructor:function(){this.query={},this.fetchProperties={}},postMixInProperties:function(){if(!this.store){var a=this.srcNodeRef;this.store=new b.form._ComboBoxDataStore(a);if(!("value"in this.params)){var c=this.item=this.store.fetchSelectedItem();if(c){var d=this._getValueField();this.value=this.store.getValue(c,d)}}}this.inherited(arguments)},postCreate:function(){var c=a.query('label[for="'+this.id+'"]');c.length&&(c[0].id=this.id+"_label",b.setWaiState(this.domNode,"labelledby",c[0].id)),this.inherited(arguments)},_setHasDownArrowAttr:function(a){this.hasDownArrow=a,this._buttonNode.style.display=a?"":"none"},_getMenuLabelFromItem:function(a){var b=this.labelFunc(a,this.store),c=this.labelType;this.highlightMatch!="none"&&this.labelType=="text"&&this._lastInput&&(b=this.doHighlight(b,this._escapeHtml(this._lastInput)),c="html");return{html:c=="html",label:b}},doHighlight:function(b,c){var d=(this.ignoreCase?"i":"")+(this.highlightMatch=="all"?"g":""),e=this.queryExpr.indexOf("${0}");c=a.regexp.escapeString(c);return this._escapeHtml(b).replace(new RegExp((e==0?"^":"")+"("+c+")"+(e==this.queryExpr.length-4?"$":""),d),'<span class="dijitComboBoxHighlightMatch">$1</span>')},_escapeHtml:function(a){a=String(a).replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;");return a},reset:function(){this.item=null,this.inherited(arguments)},labelFunc:function(a,b){return b.getValue(a,this.labelAttr||this.searchAttr).toString()}}),a.declare("dijit.form._ComboBoxMenu",[b._Widget,b._Templated,b._CssStateMixin],{templateString:"<ul class='dijitReset dijitMenu' dojoAttachEvent='onmousedown:_onMouseDown,onmouseup:_onMouseUp,onmouseover:_onMouseOver,onmouseout:_onMouseOut' style='overflow: \"auto\"; overflow-x: \"hidden\";'><li class='dijitMenuItem dijitMenuPreviousButton' dojoAttachPoint='previousButton' role='option'></li><li class='dijitMenuItem dijitMenuNextButton' dojoAttachPoint='nextButton' role='option'></li></ul>",_messages:null,baseClass:"dijitComboBoxMenu",postMixInProperties:function(){this.inherited(arguments),this._messages=a.i18n.getLocalization("dijit.form","ComboBox",this.lang)},buildRendering:function(){this.inherited(arguments),this.previousButton.innerHTML=this._messages.previousMessage,this.nextButton.innerHTML=this._messages.nextMessage},_setValueAttr:function(a){this.value=a,this.onChange(a)},onChange:function(a){},onPage:function(a){},onClose:function(){this._blurOptionNode()},_createOption:function(b,c){var d=a.create("li",{"class":"dijitReset dijitMenuItem"+(this.isLeftToRight()?"":" dijitMenuItemRtl"),role:"option"}),e=c(b);e.html?d.innerHTML=e.label:d.appendChild(a.doc.createTextNode(e.label)),d.innerHTML==""&&(d.innerHTML="&nbsp;"),d.item=b;return d},createOptions:function(b,c,d){this.previousButton.style.display=c.start==0?"none":"",a.attr(this.previousButton,"id",this.id+"_prev"),a.forEach(b,function(b,c){var e=this._createOption(b,d);a.attr(e,"id",this.id+c),this.domNode.insertBefore(e,this.nextButton)},this);var e=!1;c._maxOptions&&c._maxOptions!=-1?c.start+c.count<c._maxOptions?e=!0:c.start+c.count>c._maxOptions&&c.count==b.length&&(e=!0):c.count==b.length&&(e=!0),this.nextButton.style.display=e?"":"none",a.attr(this.nextButton,"id",this.id+"_next");return this.domNode.childNodes},clearResultList:function(){while(this.domNode.childNodes.length>2)this.domNode.removeChild(this.domNode.childNodes[this.domNode.childNodes.length-2]);this._blurOptionNode()},_onMouseDown:function(b){a.stopEvent(b)},_onMouseUp:function(a){if(a.target!==this.domNode&&this._highlighted_option)if(a.target==this.previousButton)this._blurOptionNode(),this.onPage(-1);else if(a.target==this.nextButton)this._blurOptionNode(),this.onPage(1);else{var b=a.target;while(!b.item)b=b.parentNode;this._setValueAttr({target:b},!0)}},_onMouseOver:function(a){if(a.target!==this.domNode){var b=a.target;if(b!=this.previousButton&&b!=this.nextButton)while(!b.item)b=b.parentNode;this._focusOptionNode(b)}},_onMouseOut:function(a){a.target!==this.domNode&&this._blurOptionNode()},_focusOptionNode:function(b){this._highlighted_option!=b&&(this._blurOptionNode(),this._highlighted_option=b,a.addClass(this._highlighted_option,"dijitMenuItemSelected"))},_blurOptionNode:function(){this._highlighted_option&&(a.removeClass(this._highlighted_option,"dijitMenuItemSelected"),this._highlighted_option=null)},_highlightNextOption:function(){if(this.getHighlightedOption()){var c=this._highlighted_option.nextSibling;c&&c.style.display!="none"?this._focusOptionNode(c):this.highlightFirstOption()}else{var b=this.domNode.firstChild;this._focusOptionNode(b.style.display=="none"?b.nextSibling:b)}a.window.scrollIntoView(this._highlighted_option)},highlightFirstOption:function(){var b=this.domNode.firstChild,c=b.nextSibling;this._focusOptionNode(c.style.display=="none"?b:c),a.window.scrollIntoView(this._highlighted_option)},highlightLastOption:function(){this._focusOptionNode(this.domNode.lastChild.previousSibling),a.window.scrollIntoView(this._highlighted_option)},_highlightPrevOption:function(){if(this.getHighlightedOption()){var c=this._highlighted_option.previousSibling;c&&c.style.display!="none"?this._focusOptionNode(c):this.highlightLastOption()}else{var b=this.domNode.lastChild;this._focusOptionNode(b.style.display=="none"?b.previousSibling:b)}a.window.scrollIntoView(this._highlighted_option)},_page:function(b){var c=0,d=this.domNode.scrollTop,e=a.style(this.domNode,"height");this.getHighlightedOption()||this._highlightNextOption();while(c<e){if(b){if(!this.getHighlightedOption().previousSibling||this._highlighted_option.previousSibling.style.display=="none")break;this._highlightPrevOption()}else{if(!this.getHighlightedOption().nextSibling||this._highlighted_option.nextSibling.style.display=="none")break;this._highlightNextOption()}var f=this.domNode.scrollTop;c+=(f-d)*(b?-1:1),d=f}},pageUp:function(){this._page(!0)},pageDown:function(){this._page(!1)},getHighlightedOption:function(){var a=this._highlighted_option;return a&&a.parentNode?a:null},handleKey:function(b){switch(b.charOrCode){case a.keys.DOWN_ARROW:this._highlightNextOption();return!1;case a.keys.PAGE_DOWN:this.pageDown();return!1;case a.keys.UP_ARROW:this._highlightPrevOption();return!1;case a.keys.PAGE_UP:this.pageUp();return!1;default:return!0}}}),a.declare("dijit.form.ComboBox",[b.form.ValidationTextBox,b.form.ComboBoxMixin],{_setValueAttr:function(a,c,d){this._set("item",null),a||(a=""),b.form.ValidationTextBox.prototype._setValueAttr.call(this,a,c,d)}}),a.declare("dijit.form._ComboBoxDataStore",null,{constructor:function(b){this.root=b,b.tagName!="SELECT"&&b.firstChild&&(b=a.query("select",b),b.length>0?b=b[0]:(this.root.innerHTML="<SELECT>"+this.root.innerHTML+"</SELECT>",b=this.root.firstChild),this.root=b),a.query("> option",b).forEach(function(b){b.innerHTML=a.trim(b.innerHTML)})},getValue:function(a,b,c){return b=="value"?a.value:a.innerText||a.textContent||""},isItemLoaded:function(a){return!0},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0}},_fetchItems:function(b,c,d){b.query||(b.query={}),b.query.name||(b.query.name=""),b.queryOptions||(b.queryOptions={});var e=a.data.util.filter.patternToRegExp(b.query.name,b.queryOptions.ignoreCase),f=a.query("> option",this.root).filter(function(a){return(a.innerText||a.textContent||"").match(e)});b.sort&&f.sort(a.data.util.sorter.createSortFunction(b.sort,this)),c(f,b)},close:function(a){return},getLabel:function(a){return a.innerHTML},getIdentity:function(b){return a.attr(b,"value")},fetchItemByIdentity:function(b){var c=a.query("> option[value='"+b.identity+"']",this.root)[0];b.onItem(c)},fetchSelectedItem:function(){var b=this.root,c=b.selectedIndex;return typeof c=="number"?a.query("> option:nth-child("+(c!=-1?c+1:1)+")",b)[0]:null}}),a.extend(b.form._ComboBoxDataStore,a.data.util.simpleFetch);return b.form.ComboBox})