define("dijit/_base/focus",["dojo","dijit","dojo/window","dijit/_base/manager"],function(a,b){a.mixin(b,{_curFocus:null,_prevFocus:null,isCollapsed:function(){return b.getBookmark().isCollapsed},getBookmark:function(){var c,d,e,f=a.doc.selection,g=b._curFocus;if(a.global.getSelection){f=a.global.getSelection();if(f)if(f.isCollapsed){e=g?g.tagName:"";if(e){e=e.toLowerCase();if(e=="textarea"||e=="input"&&(!g.type||g.type.toLowerCase()=="text")){f={start:g.selectionStart,end:g.selectionEnd,node:g,pRange:!0};return{isCollapsed:f.end<=f.start,mark:f}}}c={isCollapsed:!0},f.rangeCount&&(c.mark=f.getRangeAt(0).cloneRange())}else d=f.getRangeAt(0),c={isCollapsed:!1,mark:d.cloneRange()}}else if(f){e=g?g.tagName:"",e=e.toLowerCase();if(g&&e&&(e=="button"||e=="textarea"||e=="input")){if(f.type&&f.type.toLowerCase()=="none")return{isCollapsed:!0,mark:null};d=f.createRange();return{isCollapsed:d.text&&d.text.length?!1:!0,mark:{range:d,pRange:!0}}}c={};try{d=f.createRange(),c.isCollapsed=!(f.type=="Text"?d.htmlText.length:d.length)}catch(h){c.isCollapsed=!0;return c}if(f.type.toUpperCase()=="CONTROL")if(d.length){c.mark=[];var i=0,j=d.length;while(i<j)c.mark.push(d.item(i++))}else c.isCollapsed=!0,c.mark=null;else c.mark=d.getBookmark()}else console.warn("No idea how to store the current selection for this browser!");return c},moveToBookmark:function(b){var c=a.doc,d=b.mark;if(d)if(a.global.getSelection){var e=a.global.getSelection();if(e&&e.removeAllRanges)if(d.pRange){var f=d,g=f.node;g.selectionStart=f.start,g.selectionEnd=f.end}else e.removeAllRanges(),e.addRange(d);else console.warn("No idea how to restore selection for this browser!")}else if(c.selection&&d){var h;d.pRange?h=d.range:a.isArray(d)?(h=c.body.createControlRange(),a.forEach(d,function(a){h.addElement(a)})):(h=c.body.createTextRange(),h.moveToBookmark(d)),h.select()}},getFocus:function(c,d){var e=!b._curFocus||c&&a.isDescendant(b._curFocus,c.domNode)?b._prevFocus:b._curFocus;return{node:e,bookmark:e==b._curFocus&&a.withGlobal(d||a.global,b.getBookmark),openedForWindow:d}},focus:function(c){if(c){var d="node"in c?c.node:c,e=c.bookmark,f=c.openedForWindow,g=e?e.isCollapsed:!1;if(d){var h=d.tagName.toLowerCase()=="iframe"?d.contentWindow:d;if(h&&h.focus)try{h.focus()}catch(i){}b._onFocusNode(d)}if(e&&a.withGlobal(f||a.global,b.isCollapsed)&&!g){f&&f.focus();try{a.withGlobal(f||a.global,b.moveToBookmark,null,[e])}catch(j){}}}},_activeStack:[],registerIframe:function(a){return b.registerWin(a.contentWindow,a)},unregisterIframe:function(a){b.unregisterWin(a)},registerWin:function(c,d){var e=function(c){b._justMouseDowned=!0,setTimeout(function(){b._justMouseDowned=!1},0);a.isIE&&c&&c.srcElement&&c.srcElement.parentNode==null||b._onTouchNode(d||c.target||c.srcElement,"mouse")},f=a.isIE?c.document.documentElement:c.document;if(f){if(a.isIE){c.document.body.attachEvent("onmousedown",e);var g=function(a){a.srcElement.tagName.toLowerCase()!="#document"&&b.isTabNavigable(a.srcElement)?b._onFocusNode(d||a.srcElement):b._onTouchNode(d||a.srcElement)};f.attachEvent("onactivate",g);var h=function(a){b._onBlurNode(d||a.srcElement)};f.attachEvent("ondeactivate",h);return function(){c.document.detachEvent("onmousedown",e),f.detachEvent("onactivate",g),f.detachEvent("ondeactivate",h),f=null}}f.body.addEventListener("mousedown",e,!0);var i=function(a){b._onFocusNode(d||a.target)};f.addEventListener("focus",i,!0);var j=function(a){b._onBlurNode(d||a.target)};f.addEventListener("blur",j,!0);return function(){f.body.removeEventListener("mousedown",e,!0),f.removeEventListener("focus",i,!0),f.removeEventListener("blur",j,!0),f=null}}},unregisterWin:function(a){a&&a()},_onBlurNode:function(a){b._prevFocus=b._curFocus,b._curFocus=null;b._justMouseDowned||(b._clearActiveWidgetsTimer&&clearTimeout(b._clearActiveWidgetsTimer),b._clearActiveWidgetsTimer=setTimeout(function(){delete b._clearActiveWidgetsTimer,b._setStack([]),b._prevFocus=null},100))},_onTouchNode:function(c,d){b._clearActiveWidgetsTimer&&(clearTimeout(b._clearActiveWidgetsTimer),delete b._clearActiveWidgetsTimer);var e=[];try{while(c){var f=a.attr(c,"dijitPopupParent");if(f)c=b.byId(f).domNode;else if(c.tagName&&c.tagName.toLowerCase()=="body"){if(c===a.body())break;c=a.window.get(c.ownerDocument).frameElement}else{var g=c.getAttribute&&c.getAttribute("widgetId"),h=g&&b.byId(g);h&&(d!="mouse"||!h.get("disabled"))&&e.unshift(g),c=c.parentNode}}}catch(i){}b._setStack(e,d)},_onFocusNode:function(c){if(c){if(c.nodeType==9)return;b._onTouchNode(c);if(c==b._curFocus)return;b._curFocus&&(b._prevFocus=b._curFocus),b._curFocus=c,a.publish("focusNode",[c])}},_setStack:function(c,d){var e=b._activeStack;b._activeStack=c;for(var f=0;f<Math.min(e.length,c.length);f++)if(e[f]!=c[f])break;var g;for(var h=e.length-1;h>=f;h--)g=b.byId(e[h]),g&&(g._focused=!1,g.set("focused",!1),g._hasBeenBlurred=!0,g._onBlur&&g._onBlur(d),a.publish("widgetBlur",[g,d]));for(h=f;h<c.length;h++)g=b.byId(c[h]),g&&(g._focused=!0,g.set("focused",!0),g._onFocus&&g._onFocus(d),a.publish("widgetFocus",[g,d]))}}),a.addOnLoad(function(){var c=b.registerWin(window);a.isIE&&a.addOnWindowUnload(function(){b.unregisterWin(c),c=null})});return b})