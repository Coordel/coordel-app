define("dijit/Tree",["dojo","dijit","text!dijit/templates/TreeNode.html","text!dijit/templates/Tree.html","dojo/fx","dojo/DeferredList","dijit/_Widget","dijit/_Templated","dijit/_Container","dijit/_Contained","dijit/_CssStateMixin","dojo/cookie","dijit/tree/TreeStoreModel","dijit/tree/ForestStoreModel","dijit/tree/_dndSelector"],function(a,b){a.declare("dijit._TreeNode",[b._Widget,b._Templated,b._Container,b._Contained,b._CssStateMixin],{item:null,isTreeNode:!0,label:"",isExpandable:null,isExpanded:!1,state:"UNCHECKED",templateString:a.cache("dijit","templates/TreeNode.html"),baseClass:"dijitTreeNode",cssStateNodes:{rowNode:"dijitTreeRow",labelNode:"dijitTreeLabel"},attributeMap:a.delegate(b._Widget.prototype.attributeMap,{label:{node:"labelNode",type:"innerText"},tooltip:{node:"rowNode",type:"attribute",attribute:"title"}}),buildRendering:function(){this.inherited(arguments),this._setExpando(),this._updateItemClasses(this.item),this.isExpandable&&b.setWaiState(this.labelNode,"expanded",this.isExpanded),this.setSelected(!1)},_setIndentAttr:function(b){var c=Math.max(b,0)*this.tree._nodePixelIndent+"px";a.style(this.domNode,"backgroundPosition",c+" 0px"),a.style(this.rowNode,this.isLeftToRight()?"paddingLeft":"paddingRight",c),a.forEach(this.getChildren(),function(a){a.set("indent",b+1)}),this._set("indent",b)},markProcessing:function(){this.state="LOADING",this._setExpando(!0)},unmarkProcessing:function(){this._setExpando(!1)},_updateItemClasses:function(a){var b=this.tree,c=b.model;b._v10Compat&&a===c.root&&(a=null),this._applyClassAndStyle(a,"icon","Icon"),this._applyClassAndStyle(a,"label","Label"),this._applyClassAndStyle(a,"row","Row")},_applyClassAndStyle:function(b,c,d){var e="_"+c+"Class",f=c+"Node",g=this[e];this[e]=this.tree["get"+d+"Class"](b,this.isExpanded),a.replaceClass(this[f],this[e]||"",g||""),a.style(this[f],this.tree["get"+d+"Style"](b,this.isExpanded)||{})},_updateLayout:function(){var b=this.getParent();b&&b.rowNode.style.display!="none"?a.toggleClass(this.domNode,"dijitTreeIsLast",!this.getNextSibling()):a.addClass(this.domNode,"dijitTreeIsRoot")},_setExpando:function(b){var c=["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"],d=["*","-","+","*"],e=b?0:this.isExpandable?this.isExpanded?1:2:3;a.replaceClass(this.expandoNode,c[e],c),this.expandoNodeText.innerHTML=d[e]},expand:function(){if(this._expandDeferred)return this._expandDeferred;this._wipeOut&&this._wipeOut.stop(),this.isExpanded=!0,b.setWaiState(this.labelNode,"expanded","true"),(this.tree.showRoot||this!==this.tree.rootNode)&&b.setWaiRole(this.containerNode,"group"),a.addClass(this.contentNode,"dijitTreeContentExpanded"),this._setExpando(),this._updateItemClasses(this.item),this==this.tree.rootNode&&b.setWaiState(this.tree.domNode,"expanded","true");var c,d=a.fx.wipeIn({node:this.containerNode,duration:b.defaultDuration,onEnd:function(){c.callback(!0)}});c=this._expandDeferred=new a.Deferred(function(){d.stop()}),d.play();return c},collapse:function(){this.isExpanded&&(this._expandDeferred&&(this._expandDeferred.cancel(),delete this._expandDeferred),this.isExpanded=!1,b.setWaiState(this.labelNode,"expanded","false"),this==this.tree.rootNode&&b.setWaiState(this.tree.domNode,"expanded","false"),a.removeClass(this.contentNode,"dijitTreeContentExpanded"),this._setExpando(),this._updateItemClasses(this.item),this._wipeOut||(this._wipeOut=a.fx.wipeOut({node:this.containerNode,duration:b.defaultDuration})),this._wipeOut.play())},indent:0,setChildItems:function(c){var d=this.tree,e=d.model,f=[];a.forEach(this.getChildren(),function(a){b._Container.prototype.removeChild.call(this,a)},this),this.state="LOADED",c&&c.length>0?(this.isExpandable=!0,a.forEach(c,function(a){var b=e.getIdentity(a),c=d._itemNodesMap[b],g;if(c)for(var h=0;h<c.length;h++)if(c[h]&&!c[h].getParent()){g=c[h],g.set("indent",this.indent+1);break}g||(g=this.tree._createTreeNode({item:a,tree:d,isExpandable:e.mayHaveChildren(a),label:d.getLabel(a),tooltip:d.getTooltip(a),dir:d.dir,lang:d.lang,indent:this.indent+1}),c?c.push(g):d._itemNodesMap[b]=[g]),this.addChild(g),(this.tree.autoExpand||this.tree._state(a))&&f.push(d._expandNode(g))},this),a.forEach(this.getChildren(),function(a,b){a._updateLayout()})):this.isExpandable=!1,this._setExpando&&this._setExpando(!1),this._updateItemClasses(this.item);if(this==d.rootNode){var g=this.tree.showRoot?this:this.getChildren()[0];g?(g.setFocusable(!0),d.lastFocused=g):d.domNode.setAttribute("tabIndex","0")}return new a.DeferredList(f)},getTreePath:function(){var a=this,b=[];while(a&&a!==this.tree.rootNode)b.unshift(a.item),a=a.getParent();b.unshift(this.tree.rootNode.item);return b},getIdentity:function(){return this.tree.model.getIdentity(this.item)},removeChild:function(b){this.inherited(arguments);var c=this.getChildren();c.length==0&&(this.isExpandable=!1,this.collapse()),a.forEach(c,function(a){a._updateLayout()})},makeExpandable:function(){this.isExpandable=!0,this._setExpando(!1)},_onLabelFocus:function(a){this.tree._onNodeFocus(this)},setSelected:function(c){b.setWaiState(this.labelNode,"selected",c),a.toggleClass(this.rowNode,"dijitTreeRowSelected",c)},setFocusable:function(a){this.labelNode.setAttribute("tabIndex",a?"0":"-1")},_onClick:function(a){this.tree._onClick(this,a)},_onDblClick:function(a){this.tree._onDblClick(this,a)},_onMouseEnter:function(a){this.tree._onNodeMouseEnter(this,a)},_onMouseLeave:function(a){this.tree._onNodeMouseLeave(this,a)}}),a.declare("dijit.Tree",[b._Widget,b._Templated],{store:null,model:null,query:null,label:"",showRoot:!0,childrenAttr:["children"],paths:[],path:[],selectedItems:null,selectedItem:null,openOnClick:!1,openOnDblClick:!1,templateString:a.cache("dijit","templates/Tree.html"),persist:!0,autoExpand:!1,dndController:"dijit.tree._dndSelector",dndParams:["onDndDrop","itemCreator","onDndCancel","checkAcceptance","checkItemAcceptance","dragThreshold","betweenThreshold"],onDndDrop:null,itemCreator:null,onDndCancel:null,checkAcceptance:null,checkItemAcceptance:null,dragThreshold:5,betweenThreshold:0,_nodePixelIndent:19,_publish:function(b,c){a.publish(this.id,[a.mixin({tree:this,event:b},c||{})])},postMixInProperties:function(){this.tree=this,this.autoExpand&&(this.persist=!1),this._itemNodesMap={},this.cookieName||(this.cookieName=this.id+"SaveStateCookie"),this._loadDeferred=new a.Deferred,this.inherited(arguments)},postCreate:function(){this._initState(),this.model||this._store2model(),this.connect(this.model,"onChange","_onItemChange"),this.connect(this.model,"onChildrenChange","_onItemChildrenChange"),this.connect(this.model,"onDelete","_onItemDelete"),this._load(),this.inherited(arguments);if(this.dndController){a.isString(this.dndController)&&(this.dndController=a.getObject(this.dndController));var b={};for(var c=0;c<this.dndParams.length;c++)this[this.dndParams[c]]&&(b[this.dndParams[c]]=this[this.dndParams[c]]);this.dndController=new this.dndController(this,b)}},_store2model:function(){this._v10Compat=!0,a.deprecated("Tree: from version 2.0, should specify a model object rather than a store/query");var c={id:this.id+"_ForestStoreModel",store:this.store,query:this.query,childrenAttrs:this.childrenAttr};this.params.mayHaveChildren&&(c.mayHaveChildren=a.hitch(this,"mayHaveChildren")),this.params.getItemChildren&&(c.getChildren=a.hitch(this,function(a,b,c){this.getItemChildren(this._v10Compat&&a===this.model.root?null:a,b,c)})),this.model=new b.tree.ForestStoreModel(c),this.showRoot=Boolean(this.label)},onLoad:function(){},_load:function(){this.model.getRoot(a.hitch(this,function(c){var d=this.rootNode=this.tree._createTreeNode({item:c,tree:this,isExpandable:!0,label:this.label||this.getLabel(c),indent:this.showRoot?0:-1});this.showRoot||(d.rowNode.style.display="none",b.setWaiRole(this.domNode,"presentation"),b.setWaiRole(d.labelNode,"presentation"),b.setWaiRole(d.containerNode,"tree")),this.domNode.appendChild(d.domNode);var e=this.model.getIdentity(c);this._itemNodesMap[e]?this._itemNodesMap[e].push(d):this._itemNodesMap[e]=[d],d._updateLayout(),this._expandNode(d).addCallback(a.hitch(this,function(){this._loadDeferred.callback(!0),this.onLoad()}))}),function(a){console.error(this,": error loading root: ",a)})},getNodesByItem:function(b){if(!b)return[];var c=a.isString(b)?b:this.model.getIdentity(b);return[].concat(this._itemNodesMap[c])},_setSelectedItemAttr:function(a){this.set("selectedItems",[a])},_setSelectedItemsAttr:function(b){var c=this;this._loadDeferred.addCallback(a.hitch(this,function(){var d=a.map(b,function(b){return!b||a.isString(b)?b:c.model.getIdentity(b)}),e=[];a.forEach(d,function(a){e=e.concat(c._itemNodesMap[a]||[])}),this.set("selectedNodes",e)}))},_setPathAttr:function(a){return a.length?this.set("paths",[a]):this.set("paths",[])},_setPathsAttr:function(b){function e(b){c.set("selectedNodes",a.map(a.filter(b,function(a){return a[0]}),function(a){return a[1]}))}function d(b,e,f){var g=b.shift(),h=a.filter(e,function(a){return a.getIdentity()==g})[0];h?b.length?c._expandNode(h).addCallback(function(){d(b,h.getChildren(),f)}):f.callback(h):f.errback("Could not expand path at "+g)}var c=this;return(new a.DeferredList(a.map(b,function(b){var e=new a.Deferred;b=a.map(b,function(b){return a.isString(b)?b:c.model.getIdentity(b)}),b.length?c._loadDeferred.addCallback(function(){d(b,[c.rootNode],e)}):e.errback("Empty path");return e}))).addCallback(e)},_setSelectedNodeAttr:function(a){this.set("selectedNodes",[a])},_setSelectedNodesAttr:function(b){this._loadDeferred.addCallback(a.hitch(this,function(){this.dndController.setSelection(b)}))},mayHaveChildren:function(a){},getItemChildren:function(a,b){},getLabel:function(a){return this.model.getLabel(a)},getIconClass:function(a,b){return!a||this.model.mayHaveChildren(a)?b?"dijitFolderOpened":"dijitFolderClosed":"dijitLeaf"},getLabelClass:function(a,b){},getRowClass:function(a,b){},getIconStyle:function(a,b){},getLabelStyle:function(a,b){},getRowStyle:function(a,b){},getTooltip:function(a){return""},_onKeyPress:function(c){if(!c.altKey){var d=a.keys,e=b.getEnclosingWidget(c.target);if(!e)return;var f=c.charOrCode;if(typeof f=="string"&&f!=" ")!c.altKey&&!c.ctrlKey&&!c.shiftKey&&!c.metaKey&&(this._onLetterKeyNav({node:e,key:f.toLowerCase()}),a.stopEvent(c));else{this._curSearch&&(clearTimeout(this._curSearch.timer),delete this._curSearch);var g=this._keyHandlerMap;g||(g={},g[d.ENTER]="_onEnterKey",g[d.SPACE]=g[" "]="_onEnterKey",g[this.isLeftToRight()?d.LEFT_ARROW:d.RIGHT_ARROW]="_onLeftArrow",g[this.isLeftToRight()?d.RIGHT_ARROW:d.LEFT_ARROW]="_onRightArrow",g[d.UP_ARROW]="_onUpArrow",g[d.DOWN_ARROW]="_onDownArrow",g[d.HOME]="_onHomeKey",g[d.END]="_onEndKey",this._keyHandlerMap=g),this._keyHandlerMap[f]&&(this[this._keyHandlerMap[f]]({node:e,item:e.item,evt:c}),a.stopEvent(c))}}},_onEnterKey:function(b){this._publish("execute",{item:b.item,node:b.node}),this.dndController.userSelect(b.node,a.isCopyKey(b.evt),b.evt.shiftKey),this.onClick(b.item,b.node,b.evt)},_onDownArrow:function(a){var b=this._getNextNode(a.node);b&&b.isTreeNode&&this.focusNode(b)},_onUpArrow:function(a){var b=a.node,c=b.getPreviousSibling();if(c){b=c;while(b.isExpandable&&b.isExpanded&&b.hasChildren()){var d=b.getChildren();b=d[d.length-1]}}else{var e=b.getParent();if(this.showRoot||e!==this.rootNode)b=e}b&&b.isTreeNode&&this.focusNode(b)},_onRightArrow:function(a){var b=a.node;b.isExpandable&&!b.isExpanded?this._expandNode(b):b.hasChildren()&&(b=b.getChildren()[0],b&&b.isTreeNode&&this.focusNode(b))},_onLeftArrow:function(a){var b=a.node;if(b.isExpandable&&b.isExpanded)this._collapseNode(b);else{var c=b.getParent();c&&c.isTreeNode&&(this.showRoot||c!==this.rootNode)&&this.focusNode(c)}},_onHomeKey:function(){var a=this._getRootOrFirstNode();a&&this.focusNode(a)},_onEndKey:function(a){var b=this.rootNode;while(b.isExpanded){var c=b.getChildren();b=c[c.length-1]}b&&b.isTreeNode&&this.focusNode(b)},multiCharSearchDuration:250,_onLetterKeyNav:function(a){var b=this._curSearch;b?(b.pattern=b.pattern+a.key,clearTimeout(b.timer)):b=this._curSearch={pattern:a.key,startNode:a.node};var c=this;b.timer=setTimeout(function(){delete c._curSearch},this.multiCharSearchDuration);var d=b.startNode;do d=this._getNextNode(d),d||(d=this._getRootOrFirstNode());while(d!==b.startNode&&d.label.toLowerCase().substr(0,b.pattern.length)!=b.pattern);d&&d.isTreeNode&&(d!==b.startNode&&this.focusNode(d))},isExpandoNode:function(b,c){return a.isDescendant(b,c.expandoNode)},_onClick:function(b,c){var d=c.target,e=this.isExpandoNode(d,b);this.openOnClick&&b.isExpandable||e?b.isExpandable&&this._onExpandoClick({node:b}):(this._publish("execute",{item:b.item,node:b,evt:c}),this.onClick(b.item,b,c),this.focusNode(b)),a.stopEvent(c)},_onDblClick:function(b,c){var d=c.target,e=d==b.expandoNode||d==b.expandoNodeText;this.openOnDblClick&&b.isExpandable||e?b.isExpandable&&this._onExpandoClick({node:b}):(this._publish("execute",{item:b.item,node:b,evt:c}),this.onDblClick(b.item,b,c),this.focusNode(b)),a.stopEvent(c)},_onExpandoClick:function(a){var b=a.node;this.focusNode(b),b.isExpanded?this._collapseNode(b):this._expandNode(b)},onClick:function(a,b,c){},onDblClick:function(a,b,c){},onOpen:function(a,b){},onClose:function(a,b){},_getNextNode:function(a){if(a.isExpandable&&a.isExpanded&&a.hasChildren())return a.getChildren()[0];while(a&&a.isTreeNode){var b=a.getNextSibling();if(b)return b;a=a.getParent()}return null},_getRootOrFirstNode:function(){return this.showRoot?this.rootNode:this.rootNode.getChildren()[0]},_collapseNode:function(a){a._expandNodeDeferred&&delete a._expandNodeDeferred;if(a.isExpandable){if(a.state=="LOADING")return;a.collapse(),this.onClose(a.item,a),a.item&&(this._state(a.item,!1),this._saveState())}},_expandNode:function(b,c){if(b._expandNodeDeferred&&!c)return b._expandNodeDeferred;var d=this.model,e=b.item,f=this;switch(b.state){case"UNCHECKED":b.markProcessing();var g=b._expandNodeDeferred=new a.Deferred;d.getChildren(e,function(a){b.unmarkProcessing();var c=b.setChildItems(a),d=f._expandNode(b,!0);c.addCallback(function(){d.addCallback(function(){g.callback()})})},function(a){console.error(f,": error loading root children: ",a)});break;default:g=b._expandNodeDeferred=b.expand(),this.onOpen(b.item,b),e&&(this._state(e,!0),this._saveState())}return g},focusNode:function(a){b.focus(a.labelNode)},_onNodeFocus:function(a){a&&a!=this.lastFocused&&(this.lastFocused&&!this.lastFocused._destroyed&&this.lastFocused.setFocusable(!1),a.setFocusable(!0),this.lastFocused=a)},_onNodeMouseEnter:function(a){},_onNodeMouseLeave:function(a){},_onItemChange:function(b){var c=this.model,d=c.getIdentity(b),e=this._itemNodesMap[d];if(e){var f=this.getLabel(b),g=this.getTooltip(b);a.forEach(e,function(a){a.set({item:b,label:f,tooltip:g}),a._updateItemClasses(b)})}},_onItemChildrenChange:function(b,c){var d=this.model,e=d.getIdentity(b),f=this._itemNodesMap[e];f&&a.forEach(f,function(a){a.setChildItems(c)})},_onItemDelete:function(b){var c=this.model,d=c.getIdentity(b),e=this._itemNodesMap[d];e&&(a.forEach(e,function(a){this.dndController.removeTreeNode(a);var b=a.getParent();b&&b.removeChild(a),a.destroyRecursive()},this),delete this._itemNodesMap[d])},_initState:function(){if(this.persist){var b=a.cookie(this.cookieName);this._openedItemIds={},b&&a.forEach(b.split(","),function(a){this._openedItemIds[a]=!0},this)}},_state:function(a,b){if(!this.persist)return!1;var c=this.model.getIdentity(a);if(arguments.length===1)return this._openedItemIds[c];b?this._openedItemIds[c]=!0:delete this._openedItemIds[c]},_saveState:function(){if(this.persist){var b=[];for(var c in this._openedItemIds)b.push(c);a.cookie(this.cookieName,b.join(","),{expires:365})}},destroy:function(){this._curSearch&&(clearTimeout(this._curSearch.timer),delete this._curSearch),this.rootNode&&this.rootNode.destroyRecursive(),this.dndController&&!a.isString(this.dndController)&&this.dndController.destroy(),this.rootNode=null,this.inherited(arguments)},destroyRecursive:function(){this.destroy()},resize:function(b){b&&a.marginBox(this.domNode,b),this._nodePixelIndent=a._getMarginSize(this.tree.indentDetector).w,this.tree.rootNode&&this.tree.rootNode.set("indent",this.showRoot?0:-1)},_createTreeNode:function(a){return new b._TreeNode(a)}});return b.Tree})