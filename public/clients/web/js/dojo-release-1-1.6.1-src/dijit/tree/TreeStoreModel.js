define("dijit/tree/TreeStoreModel",["dojo","dijit"],function(a,b){a.declare("dijit.tree.TreeStoreModel",null,{store:null,childrenAttrs:["children"],newItemIdAttr:"id",labelAttr:"",root:null,query:null,deferItemLoadingUntilExpand:!1,constructor:function(b){a.mixin(this,b),this.connects=[];var c=this.store;if(!c.getFeatures()["dojo.data.api.Identity"])throw new Error("dijit.Tree: store must support dojo.data.Identity");c.getFeatures()["dojo.data.api.Notification"]&&(this.connects=this.connects.concat([a.connect(c,"onNew",this,"onNewItem"),a.connect(c,"onDelete",this,"onDeleteItem"),a.connect(c,"onSet",this,"onSetItem")]))},destroy:function(){a.forEach(this.connects,a.disconnect)},getRoot:function(b,c){this.root?b(this.root):this.store.fetch({query:this.query,onComplete:a.hitch(this,function(c){if(c.length!=1)throw new Error(this.declaredClass+": query "+a.toJson(this.query)+" returned "+c.length+" items, but must return exactly one item");this.root=c[0],b(this.root)}),onError:c})},mayHaveChildren:function(b){return a.some(this.childrenAttrs,function(a){return this.store.hasAttribute(b,a)},this)},getChildren:function(b,c,d){var e=this.store;if(e.isItemLoaded(b)){var g=[];for(var h=0;h<this.childrenAttrs.length;h++){var i=e.getValues(b,this.childrenAttrs[h]);g=g.concat(i)}var j=0;this.deferItemLoadingUntilExpand||a.forEach(g,function(a){e.isItemLoaded(a)||j++}),j==0?c(g):a.forEach(g,function(a,b){e.isItemLoaded(a)||e.loadItem({item:a,onItem:function(a){g[b]=a,--j==0&&c(g)},onError:d})})}else{var f=a.hitch(this,arguments.callee);e.loadItem({item:b,onItem:function(a){f(a,c,d)},onError:d})}},isItem:function(a){return this.store.isItem(a)},fetchItemByIdentity:function(a){this.store.fetchItemByIdentity(a)},getIdentity:function(a){return this.store.getIdentity(a)},getLabel:function(a){return this.labelAttr?this.store.getValue(a,this.labelAttr):this.store.getLabel(a)},newItem:function(a,b,c){var d={parent:b,attribute:this.childrenAttrs[0]},e;this.newItemIdAttr&&a[this.newItemIdAttr]?this.fetchItemByIdentity({identity:a[this.newItemIdAttr],scope:this,onItem:function(f){f?this.pasteItem(f,null,b,!0,c):(e=this.store.newItem(a,d),e&&c!=undefined&&this.pasteItem(e,b,b,!1,c))}}):(e=this.store.newItem(a,d),e&&c!=undefined&&this.pasteItem(e,b,b,!1,c))},pasteItem:function(b,c,d,e,f){var g=this.store,h=this.childrenAttrs[0];c&&a.forEach(this.childrenAttrs,function(d){if(g.containsValue(c,d,b)){if(!e){var f=a.filter(g.getValues(c,d),function(a){return a!=b});g.setValues(c,d,f)}h=d}});if(d)if(typeof f=="number"){var i=g.getValues(d,h).slice();i.splice(f,0,b),g.setValues(d,h,i)}else g.setValues(d,h,g.getValues(d,h).concat(b))},onChange:function(a){},onChildrenChange:function(a,b){},onDelete:function(a,b){},onNewItem:function(b,c){c&&this.getChildren(c.item,a.hitch(this,function(a){this.onChildrenChange(c.item,a)}))},onDeleteItem:function(a){this.onDelete(a)},onSetItem:function(b,c,d,e){a.indexOf(this.childrenAttrs,c)!=-1?this.getChildren(b,a.hitch(this,function(a){this.onChildrenChange(b,a)})):this.onChange(b)}});return b.tree.TreeStoreModel})