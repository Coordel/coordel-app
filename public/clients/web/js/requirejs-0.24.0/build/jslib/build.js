define(["lang","logger","env!env/file","parse","optimize","pragma","env!env/load","requirePatch"],function(lang,logger,file,parse,optimize,pragma,load,requirePatch){function endsWithSlash(a){a.charAt(a.length-1)!=="/"&&(a+="/");return a}var build,buildBaseConfig;buildBaseConfig={requireBuildPath:"../",appDir:"",pragmas:{},paths:{},optimize:"uglify",optimizeCss:"standard.keepLines",inlineText:!0,isBuild:!0},build=function(a){var b,c,d;if(!a||lang.isArray(a)){if(!a||a.length<2){logger.error("build.js directory/containing/build.js/ buildProfile.js\nwhere buildProfile.js is the name of the build file (see example.build.js for hints on how to make a build file).");return}b=a[0],b=endsWithSlash(b),a[1].indexOf("=")===-1?(c=a[1],a.splice(0,2)):a.splice(0,1),d=build.convertArrayToObject(a),d.buildFile=c,d.requireBuildPath=b}else d=a;build._run(d)},build._run=function(a){var b="",c,d,e,f,g,h,i,j,k,l,m,n,o;requirePatch(),j=build.createConfig(a),g=j.paths;if(!j.out&&!j.cssIn){file.copyDir(j.appDir||j.baseUrl,j.dir,/\w/,!0),c={};if(j.appDir)c=g;else for(f in g)g.hasOwnProperty(f)&&(c[f]=f.replace(/\./g,"/"),m=g[f],m.indexOf("/")!==0&&m.indexOf(":")===-1&&(m=j.baseUrl+m),o=j.dirBaseUrl+c[f],file.exists(m)&&file.isDirectory(m)?file.copyDir(m,o,/\w/,!0):(m+=".js",o+=".js",file.copyFile(m,o)))}require({baseUrl:j.baseUrl,paths:g,packagePaths:j.packagePaths,packages:j.packages}),n=require.s.contexts._,k=j.modules,k&&k.forEach(function(a){if(a.name){a._sourcePath=n.nameToUrl(a.name);if(!file.exists(a._sourcePath)&&!a.create&&a.name.indexOf("!")===-1)throw new Error("ERROR: module path does not exist: "+a._sourcePath+" for module named: "+a.name+". Path is relative to: "+file.absPath("."))}}),j.out?(require(j),j.cssIn||(j.modules[0]._buildPath=j.out)):j.cssIn||(i={baseUrl:j.dirBaseUrl,paths:c},lang.mixin(i,j),require(i),k&&k.forEach(function(a){a.name&&(a._buildPath=n.nameToUrl(a.name,null),a.create||file.copyFile(a._sourcePath,a._buildPath))})),k&&(k.forEach(function(a){a.layer=build.traceDependencies(a,j)}),k.forEach(function(a){a.exclude&&(a.excludeLayers=[],a.exclude.forEach(function(b,c){a.excludeLayers[c]=build.findBuildModule(b,k)||{layer:build.traceDependencies({name:b},j)}}))}),k.forEach(function(a){a.exclude&&a.exclude.forEach(function(b,c){var d=a.excludeLayers[c].layer,e=d.buildPathMap,f;for(f in e)e.hasOwnProperty(f)&&build.removeModulePath(f,e[f],a.layer)}),a.excludeShallow&&a.excludeShallow.forEach(function(b){var c=a.layer.buildPathMap[b];c&&build.removeModulePath(b,c,a.layer)}),l=build.flattenModule(a,a.layer,j),file.saveUtf8File(a._buildPath,l.text),b+=l.buildText}));if(j.out&&!j.cssIn)d=j.modules[0]._buildPath,optimize.jsFile(d,d,j);else if(!j.cssIn){e=file.getFilteredFileList(j.dir,/\.js$/,!0);for(h=0;d=e[h];h++)optimize.jsFile(d,d,j);j.optimizeCss&&j.optimizeCss!=="none"&&optimize.css(j.dir,j),file.saveUtf8File(j.dir+"build.txt",b)}j.cssIn&&optimize.cssFile(j.cssIn,j.out,j),b&&logger.info(b)},build.convertArrayToObject=function(a){var b={},c,d,e,f,g={include:!0,exclude:!0,excludeShallow:!0};for(c=0;c<a.length;c++){d=a[c].indexOf("=");if(d===-1)throw"Malformed name/value pair: ["+a[c]+"]. Format should be name=value";f=a[c].substring(d+1,a[c].length),f==="true"?f=!0:f==="false"&&(f=!1),e=a[c].substring(0,d),g[e]&&(f=f.split(",")),e.indexOf("paths.")===0?(b.paths||(b.paths={}),e=e.substring("paths.".length,e.length),b.paths[e]=f):b[e]=f}return b},build.makeAbsPath=function(a,b){a.indexOf("/")!==0&&a.indexOf(":")===-1&&(a=b+(b.charAt(b.length-1)==="/"?"":"/")+a,a=file.normalize(a));return a},build.createConfig=function(cfg){var config={},buildFileContents,buildFileConfig,paths,props,i,prop,buildFile,absFilePath,originalBaseUrl;lang.mixin(config,buildBaseConfig),lang.mixin(config,cfg,!0),config.requireBuildPath.charAt(config.requireBuildPath.length-1)!=="/"&&(config.requireBuildPath+="/",cfg.requireBuildPath&&(cfg.requireBuildPath=config.requireBuildPath)),config.requireUrl=file.absPath(cfg.requireBuildPath+"../require.js");if(config.buildFile){buildFile=file.absPath(config.buildFile);if(!file.exists(buildFile))throw new Error("ERROR: build file does not exist: "+buildFile);absFilePath=config.baseUrl=file.absPath(file.parent(buildFile)),config.dir=config.baseUrl+"/build/",buildFileContents=file.readFile(buildFile);try{buildFileConfig=eval("("+buildFileContents+")")}catch(e){throw new Error("Build file "+buildFile+" is malformed: "+e)}lang.mixin(config,buildFileConfig,!0),lang.mixin(config,cfg,!0)}else{if(!config.out&&!config.cssIn)throw new Error("ERROR: 'out' or 'cssIn' option missing.");if(config.out)config.out=config.out.replace(lang.backSlashRegExp,"/");else throw new Error("ERROR: 'out' option missing.");if(!config.cssIn&&!cfg.baseUrl)throw new Error("ERROR: 'baseUrl' option missing.");absFilePath=file.absPath(".")}config.out&&!config.cssIn&&(config.modules=[{name:config.name,out:config.out,include:config.include,exclude:config.exclude,excludeShallow:config.excludeShallow}],config.includeRequire&&(config.modules[0].includeRequire=!0),cfg.optimizeCss||(config.optimizeCss="none")),props=["appDir","dir","baseUrl"];for(i=0;prop=props[i];i++)config[prop]&&(config[prop]=config[prop].replace(lang.backSlashRegExp,"/"),prop==="baseUrl"?(originalBaseUrl=config.baseUrl,config.appDir?(config.baseUrl=build.makeAbsPath(originalBaseUrl,config.appDir),config.dirBaseUrl=build.makeAbsPath(originalBaseUrl,config.dir)):(config.baseUrl=build.makeAbsPath(config[prop],absFilePath),config.dirBaseUrl=config.dir||config.baseUrl),config.dirBaseUrl=endsWithSlash(config.dirBaseUrl)):config[prop]=build.makeAbsPath(config[prop],absFilePath),config[prop]=endsWithSlash(config[prop]));props=["out","cssIn"];for(i=0;prop=props[i];i++)config[prop]&&(config[prop]=build.makeAbsPath(config[prop],absFilePath));return config},build.findBuildModule=function(a,b){var c,d;for(c=0;d=b[c];c++)if(d.name===a)return d;return null},build.removeModulePath=function(a,b,c){var d=c.buildFilePaths.indexOf(b);d!==-1&&c.buildFilePaths.splice(d,1),delete c.specified[a]},build.traceDependencies=function(a,b){var c,d,e,f,g,h;h=require._buildReset(),g=h.config,e=require._layer,f=e.context,require(lang.delegate(g)),logger.trace("\nTracing dependencies for: "+(a.name||a.out)),c=a.name&&!a.create?[a.name]:[],a.include&&(c=c.concat(a.include)),a.override&&(d=lang.delegate(g),lang.mixin(d,a.override,!0),require(d)),require(c),e.specified=f.specified,a.override&&require(g);return e},build.flattenModule=function(a,b,c){var d="",e="",f=b.context,g,h,i,j,k,l,m,n,o,p;a.override&&(c=lang.delegate(c),lang.mixin(c,a.override,!0)),d+="\n"+(c.dir?a._buildPath.replace(c.dir,""):a._buildPath)+"\n----------------\n",e="",m=!1,"includeRequire"in a&&(m=a.includeRequire),m&&(e=pragma.process(c.requireUrl,file.readFile(c.requireUrl),c),d+="require.js\n"),!m&&b.existingRequireUrl&&(h=b.buildFilePaths.indexOf(b.existingRequireUrl),h!==-1&&(b.buildFilePaths.splice(h,1),b.buildFilePaths.unshift(b.existingRequireUrl))),i="";for(k=0;g=b.buildFilePaths[k];k++)l=b.buildFileToModule[g],n=f.makeModuleMap(l),o=n.prefix&&f.pluginBuilders[n.prefix],o?o.write&&(p=function(a){i+=a},p.asModule=function(a,c){i+=build.toTransport(a,g,c,b)},o.write(n.prefix,n.name,p)):(j=pragma.process(g,file.readFile(g),c),j=build.toTransport(l,g,j,b),i+=j),d+=g.replace(c.dir,"")+"\n",l&&!b.modulesWithNames[l]&&!c.skipModuleInsertion&&(l==="jquery"?i+='\n(function () {\nvar jq = typeof jQuery !== "undefined" && jQuery;\ndefine("jquery", [], function () { return jq; });\n}());\n':i+='define("'+l+'", function(){});\n');i=(e?e+"\n":"")+i;return{text:i,buildText:d}},build.anonDefRegExp=/(require\s*\.\s*def|define)\s*\(\s*(\/\/[^\n\r]*[\r\n])?(\[|f|\{)/,build.toTransport=function(a,b,c,d){return c.replace(build.anonDefRegExp,function(e,f,g,h){d.modulesWithNames[a]=!0;var i=null;h.indexOf("f")!==-1&&(i=parse.getAnonDeps(b,c),i.length?i=i.map(function(a){return"'"+a+"'"}):i=null);return"define('"+a+"',"+(i?"["+i.toString()+"],":"")+h})};return build})