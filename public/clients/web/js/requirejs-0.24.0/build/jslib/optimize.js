define(["lang","logger","env!env/optimize","env!env/file","uglifyjs/index"],function(a,b,c,d,e){function j(c,e,f){c=c.replace(a.backSlashRegExp,"/");var k=c.lastIndexOf("/"),l=k!==-1?c.substring(0,k+1):"";f&&f.charAt(f.length-1)!==","&&(f+=",");return e.replace(g,function(e,g,k,m,n){if(n&&n.replace(/^\s\s*/,"").replace(/\s\s*$/,"")!=="all")return e;k=i(k);if(f&&f.indexOf(k+",")!==-1)return e;k=k.replace(a.backSlashRegExp,"/");try{var o=k.charAt(0)==="/"?k:l+k,p=d.readFile(o),q,r,s,t,u,v;p=j(o,p),r=k.lastIndexOf("/"),s=r!==-1?k.substring(0,r+1):"",p=p.replace(h,function(c,d){t=i(d),t=t.replace(a.backSlashRegExp,"/"),u=t.indexOf(":"),t.charAt(0)==="/"||u!==-1&&u<=t.indexOf("/")?b.trace(k+"\n  URL not a relative URL, skipping: "+d):d=s+t,v=d.split("/");for(q=v.length-1;q>0;q--)v[q]==="."?v.splice(q,1):v[q]===".."&&(q!==0&&v[q-1]!==".."&&(v.splice(q-1,2),q-=1));return"url("+v.join("/")+")"});return p}catch(w){b.trace(c+"\n  Cannot inline css import, skipping: "+k);return e}})}function i(a){a=a.replace(/\s+$/,"");if(a.charAt(0)==="'"||a.charAt(0)==='"')a=a.substring(1,a.length-1);return a}var f,g=/\@import\s+(url\()?\s*([^);]+)\s*(\))?([\w, ]*)(;)?/g,h=/\url\(\s*([^\)]+)\s*\)?/g;f={jsFile:function(a,b,e){var g=(e.optimize+"").split("."),h=g[0],i=g[1]==="keepLines",j,k;j=d.readFile(a);if(h&&h!=="none"){k=c[h]||f.optimizers[h];if(!k)throw new Error('optimizer with name of "'+h+'" not found for this environment');j=k(a,j,i,e[h])}d.saveUtf8File(b,j)},cssFile:function(a,c,e){var f=d.readFile(a),g=j(a,f,e.cssImportIgnore),h,i;try{h=-1;while((h=g.indexOf("/*"))!==-1){i=g.indexOf("*/",h+2);if(i===-1)throw"Improper comment in CSS file: "+a;g=g.substring(0,h)+g.substring(i+2,g.length)}e.optimizeCss.indexOf(".keepLines")===-1?(g=g.replace(/[\r\n]/g,""),g=g.replace(/\s+/g," "),g=g.replace(/\{\s/g,"{"),g=g.replace(/\s\}/g,"}")):(g=g.replace(/(\r\n)+/g,"\r\n"),g=g.replace(/(\n)+/g,"\n"))}catch(k){g=f,b.error("Could not optimized CSS file: "+a+", error: "+k)}d.saveUtf8File(c,g)},css:function(a,c){if(c.optimizeCss.indexOf("standard")!==-1){var e,g,h=d.getFilteredFileList(a,/\.css$/,!0);if(h)for(e=0;e<h.length;e++)g=h[e],b.trace("Optimizing ("+c.optimizeCss+") CSS file: "+g),f.cssFile(g,g,c)}},optimizers:{uglify:function(a,c,d,f){var g=e.parser,h=e.uglify,i,j;f=f||{},j=f.gen_codeOptions||d,b.trace("Uglifying file: "+a);try{i=g.parse(c,f.strict_semicolons),i=h.ast_mangle(i,f.do_toplevel),i=h.ast_squeeze(i,f.ast_squeezeOptions),c=h.gen_code(i,j)}catch(k){b.error("Cannot uglify file: "+a+". Skipping it. Error is:\n"+k.toString())}return c}}};return f})